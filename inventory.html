<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="sidebar.css">
    <link rel="stylesheet" href="inventory-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>IMS</h2>
        </div>
        <ul class="nav-links">
            <li>
                <a href="dashboard.html" >
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
            </li> <li>
                <a href="pos.html">
                    <i class="fas fa-shopping-cart"></i>
                    Pos
                </a>
            </li>
            <li>
                <a href="electronics-pos.html">
                    <i class="fas fa-shopping-cart"></i>
                    E-Pos
                </a>
            </li>
            <li>
                <a href="inventory.html"class="active">
                    <i class="fas fa-box"></i>
                    Inventory
                </a>
            </li>
            <li>
                <a href="vat.html">
                    <i class="fas fa-percent"></i>
                    Tax
                </a>
            </li>
            <li>
                <a href="sales.html">
                    <i class="fas fa-store"></i>
                    Sales
                </a>
            </li>
            <li>
                <a href="user-sales.html">
                    <i class="fas fa-exclamation-triangle"></i>
                    User-Management
                </a>
            </li>
            <li>
                <a href="employee.html">
                    <i class="fas fa-bars"></i>
                    Employee
                </a>
            </li>
            <li>
                <a href="expenses.html">
                    <i class="fas fa fa-money-bill"></i>
                    Expenses
                </a>
            </li>
            <a href="customers.html">
                <i class="fas fa fa-users"></i>
                Customer
            </a>
            <li><a href="ecommerce.html"><i class="fab fa-google-wallet"></i> Ecomerce</a></li>
            <li>
                <a href="settings.html"  >
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </li>
        </ul>
    </nav>
        <div class="container">
            <div class="filter-container">
                <div class="left-filters">
                    <button class="add-btn" onclick="openModal()">Add New Item</button>
                </div>
                <div class="filters">
                    <button id="bulkDeleteBtn" class="delete-btn" onclick="bulkDelete()" style="display: none;">Delete Selected</button>
                    <button class="print-btn" onclick="printInventory()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <input type="text" id="searchInput" class="filter-select" placeholder="Search by name/ID/brand...">
                    <input type="date" id="dateFilter" class="filter-select">
                    <select id="categoryFilter" class="filter-select" >
                        <option value="">All Categories</option>
                    </select>
                    <select id="stockFilter" class="filter-select">
                        <option value="">All Stock</option>
                        <option value="inStock">In Stock</option>
                        <option value="lowStock">Low Stock</option>
                        <option value="outOfStock">Out of Stock</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>SL</th>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th>Special Code</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="pagination-controls">
                    <button id="prevPage" class="pagination-btn">Previous</button>
                    <div id="pageNumbers" class="page-numbers"></div>
                    <button id="nextPage" class="pagination-btn">Next</button>
                </div>
            </div>
        </div>
    </div>
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <h2>Add New Item</h2>
            <form id="addItemForm">
                <div class="form-container">
                    <div class="form-group">
                        <label for="itemImage">Item Image (Optional)</label>
                        <input type="file" id="itemImage" accept="image/*">
                        <div id="imagePreview"></div>
                    </div>
                    <div class="form-group">
                        <label for="specialCodeSearch">Special Code</label>
                        <div class="special-code-wrapper">
                            <input type="text" id="specialCodeSearch" class="special-code-search" placeholder="Search special code...">
                            <input type="hidden" id="specialCode" required>
                            <div id="specialCodeDropdown" class="special-code-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name">Item Name</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="brand">Brand Name</label>
                        <input type="text" id="brand" placeholder="Enter brand name">
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" required>
                    </div>
                    <div class="form-group">
                        <label for="price">Price</label>
                        <input type="number" step="0.01" id="price" required>
                    </div>
                    <div class="form-group">
                        <label for="warranty">Warranty</label>
                        <input type="text" id="warranty" placeholder="e.g., 1 Year, 6 Months">
                    </div>
                    <div class="form-group full-width">
                        <label for="description">Description</label>
                        <textarea id="description" rows="6" placeholder="Enter item description..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <div class="modal-buttons">
                            <button id="cancel" type="button" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="add-btn">Add Item</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- Firebase scripts -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>    
    <script type="module" >
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    deleteDoc, 
    doc, 
    updateDoc, 
    getDoc 
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { 
    getStorage, 
    ref, 
    uploadBytes, 
    getDownloadURL, 
    deleteObject 
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBDz5gR_Zb-EOCga3G7pX3N2Rqwef4_hIw",
    authDomain: "supershop-bc036.firebaseapp.com",
    databaseURL: "https://supershop-bc036-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "supershop-bc036",
    storageBucket: "supershop-bc036.firebasestorage.app",
    messagingSenderId: "528401541608",
    appId: "1:528401541608:web:e1b352f95286170de09c5d",
    measurementId: "G-W4D9D0Z20S"
};
// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
// Global variables
let currentPage = 1;
const itemsPerPage = 50;
let filteredItems = [];
let currentDocId = null;
let currentCurrency = '৳';
let currentCurrencyCode = 'BDT';

// DOM elements
const modal = document.getElementById('addItemModal');
const form = document.getElementById('addItemForm');
const tableBody = document.getElementById('tableBody');
const prevPageBtn = document.getElementById('prevPage');
const nextPageBtn = document.getElementById('nextPage');
const pageNumbersDiv = document.getElementById('pageNumbers');

// Helper functions
function generateId() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

async function generateSignature(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-1', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function formatCurrency(amount) {
    return `${amount.toFixed(2)}${currentCurrency}`;
}

// Modal functions
window.openModal = function() {
    document.getElementById('addItemForm').reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.querySelector('.modal-content h2').textContent = 'Add New Item';
    document.querySelector('button[type="submit"]').textContent = 'Add Item';
    currentDocId = null;
    modal.style.display = 'block';
};

window.closeModal = function() {
    modal.style.display = 'none';
};

// Load currency settings
async function loadCurrencySettings() {
    try {
        const storeSnapshot = await getDocs(collection(db, 'storeInfo'));
        if (!storeSnapshot.empty) {
            const storeData = storeSnapshot.docs[0].data();
            currentCurrency = storeData.currencySymbol || '৳';
            currentCurrencyCode = storeData.currency || 'BDT';
        }
    } catch (error) {
        console.error('Error loading currency settings:', error);
    }
}
// Load special codes for dropdown
async function loadSpecialCodes() {
    try {
        const querySnapshot = await getDocs(collection(db, 'vatRules'));
        const specialCodes = [];
        querySnapshot.forEach((doc) => {
            const rule = doc.data();
            if (rule.specialCode) {
                specialCodes.push(rule.specialCode);
            }
        });
        return specialCodes;
    } catch (error) {
        console.error('Error loading special codes:', error);
        return [];
    }
}

// Setup special code autocomplete
function setupSpecialCodeAutocomplete() {
    const searchInput = document.getElementById('specialCodeSearch');
    const dropdown = document.getElementById('specialCodeDropdown');
    const hiddenInput = document.getElementById('specialCode');
    let specialCodes = [];

    // Load special codes
    async function loadSpecialCodesForSearch() {
        try {
            specialCodes = await loadSpecialCodes();
            // Show all codes initially when focused
            displayAllCodes();
        } catch (error) {
            console.error('Error loading special codes:', error);
        }
    }

    // Function to display all codes
    function displayAllCodes() {
        dropdown.innerHTML = '';
        specialCodes.forEach(code => {
            const div = document.createElement('div');
            div.textContent = code;
            div.onclick = () => {
                searchInput.value = code;
                hiddenInput.value = code;
                dropdown.style.display = 'none';
            };
            dropdown.appendChild(div);
        });
        dropdown.style.display = specialCodes.length ? 'block' : 'none';
    }

    // Initial load
    loadSpecialCodesForSearch();

    // Show dropdown on focus
    searchInput.addEventListener('focus', () => {
        if (specialCodes.length) {
            displayAllCodes();
        }
    });

    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        dropdown.innerHTML = '';
        
        const filtered = specialCodes.filter(code => 
            code.toLowerCase().includes(searchText)
        );

        filtered.forEach(code => {
            const div = document.createElement('div');
            div.textContent = code;
            div.onclick = () => {
                searchInput.value = code;
                hiddenInput.value = code;
                dropdown.style.display = 'none';
            };
            dropdown.appendChild(div);
        });

        dropdown.style.display = filtered.length ? 'block' : 'none';
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
}

// Setup category dropdown
async function setupCategoryScrollbar() {
    const categoryFilter = document.getElementById('categoryFilter');
    const categorySelect = document.getElementById('category');
    const defaultOptions = '<option value="">All Categories</option>';
    const formDefaultOption = '<option value="">Select Category</option>';
    
    categoryFilter.innerHTML = defaultOptions;
    categorySelect.innerHTML = formDefaultOption;
    
    try {
        // Load regular categories
        const categorySnapshot = await getDocs(collection(db, 'categories'));
        const regularCategories = categorySnapshot.docs.map(doc => ({
            name: doc.data().name,
            type: 'regular'
        })).filter(cat => cat.name);
        
        // Load e-categories
        const eCategorySnapshot = await getDocs(collection(db, 'e-categories'));
        const eCategories = eCategorySnapshot.docs.map(doc => ({
            name: doc.data().name,
            type: 'e-category'
        })).filter(cat => cat.name);
        
        // Combine and sort all categories
        const allCategories = [...regularCategories, ...eCategories].sort((a, b) => a.name.localeCompare(b.name));
        
        // Add categories to dropdowns with type indicators
        allCategories.forEach(category => {
            const displayName = category.type === 'e-category' ? `${category.name} (E)` : category.name;
            const optionValue = category.name;
            
            categoryFilter.innerHTML += `<option value="${optionValue}">${displayName}</option>`;
            categorySelect.innerHTML += `<option value="${optionValue}">${displayName}</option>`;
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Load stock settings
async function loadStockSettings() {
    try {
        const settingsSnapshot = await getDocs(collection(db, 'settings'));
        if (!settingsSnapshot.empty) {
            const settings = settingsSnapshot.docs[0].data();
            const stockFilter = document.getElementById('stockFilter');
            const lowStockThreshold = settings.lowStockThreshold || 10;
            
            stockFilter.innerHTML = `
                <option value="">All Stock</option>
                <option value="inStock">In Stock</option>
                <option value="lowStock">Low Stock (< ${lowStockThreshold})</option>
                <option value="outOfStock">Out of Stock</option>
            `;
            return lowStockThreshold;
        }
        return 10; // Default threshold
    } catch (error) {
        console.error('Error loading stock settings:', error);
        return 10; // Default threshold
    }
}

// Fetch items from Firestore
async function fetchItems() {
    await loadCurrencySettings();
    tableBody.innerHTML = '';
    
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const stockFilter = document.getElementById('stockFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    // Get stock threshold from settings
    const lowStockThreshold = await loadStockSettings();
    
    // Reset filtered items array
    filteredItems = [];
    
    try {
        const querySnapshot = await getDocs(collection(db, 'inventory'));
        console.log('Total documents found:', querySnapshot.size);
        
        querySnapshot.forEach((doc) => {
            const item = doc.data();
            const docId = doc.id;
            
            // Apply filters
            if (searchQuery) {
                const nameMatch = item.name?.toLowerCase().includes(searchQuery) || false;
                const idMatch = docId.toString().toLowerCase().includes(searchQuery);
                const brandMatch = item.brand && item.brand.toLowerCase().includes(searchQuery);
                const productIdMatch = item.productId && item.productId.toLowerCase().includes(searchQuery);
                
                // If none of the fields match the search query, skip this item
                if (!nameMatch && !idMatch && !brandMatch && !productIdMatch) return;
            }
            
            if (categoryFilter && item.category !== categoryFilter) return;
            if (dateFilter && item.createdAt && item.createdAt.split('T')[0] !== dateFilter) return;
            if (stockFilter) {
                const quantity = parseInt(item.quantity);
                if (stockFilter === 'inStock' && quantity <= lowStockThreshold) return;
                if (stockFilter === 'lowStock' && (quantity <= 0 || quantity > lowStockThreshold)) return;
                if (stockFilter === 'outOfStock' && quantity > 0) return;
            }
            
            // Add to filtered items array with doc ID
            filteredItems.push({
                ...item,
                id: docId
            });
        });
        
        console.log('Filtered items count:', filteredItems.length);
        
        // Update pagination
        updatePagination();
        
        // Display current page
        displayCurrentPage();
    } catch (error) {
        console.error('Error fetching inventory items:', error);
        alert('Error loading inventory. Please try again.');
    }
}

// Update pagination controls
function updatePagination() {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    
    // Update prev/next buttons
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
    
    // Update page numbers
    pageNumbersDiv.innerHTML = '';
    
    // Determine which page numbers to show
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    
    // Adjust start page if we're near the end
    if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
    }
    
    // Add first page and ellipsis if needed
    if (startPage > 1) {
        addPageNumber(1);
        if (startPage > 2) {
            addEllipsis();
        }
    }
    
    // Add page numbers
    for (let i = startPage; i <= endPage; i++) {
        addPageNumber(i);
    }
    
    // Add ellipsis and last page if needed
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            addEllipsis();
        }
        addPageNumber(totalPages);
    }
    
    function addPageNumber(pageNum) {
        const pageElement = document.createElement('div');
        pageElement.className = 'page-number' + (pageNum === currentPage ? ' active' : '');
        pageElement.textContent = pageNum;
        pageElement.onclick = () => {
            currentPage = pageNum;
            updatePagination();
            displayCurrentPage();
        };
        pageNumbersDiv.appendChild(pageElement);
    }
    
    function addEllipsis() {
        const ellipsis = document.createElement('div');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '...';
        pageNumbersDiv.appendChild(ellipsis);
    }
}

// Display current page of items
function displayCurrentPage() {
    tableBody.innerHTML = '';
    
    // Calculate start and end indices
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
    
    // Display items for current page
    for (let i = startIndex; i < endIndex; i++) {
        const item = filteredItems[i];
        const serialNumber = i + 1;
        const row = document.createElement('tr');
        
        // Make sure we're using the correct ID for the item
        const itemId = item.id || '';
        const displayId = item.productId || 'N/A'; // Use the 6-digit product ID for display
        
        row.innerHTML = `
            <td><input type="checkbox" class="item-checkbox" value="${itemId}" onchange="updateBulkDeleteButton()"></td>
            <td>${serialNumber}</td>
            <td>${displayId}</td>
            <td>${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover;">` : 'No Image'}</td>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${item.brand || 'N/A'}</td>
            <td>${item.specialCode}</td>
            <td>${item.quantity}</td>
            <td>${formatCurrency(parseFloat(item.price))}</td>
            <td>${item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A'}</td>
            <td>
                <button class="edit-btn" onclick="editItem('${itemId}')">Edit</button>
                <button class="delete-btn" onclick="deleteItem('${itemId}')">Delete</button>
            </td>
        `;
        tableBody.appendChild(row);
    }
    
    // Update select all checkbox state
    document.getElementById('selectAll').checked = false;
    updateBulkDeleteButton();
}

// Edit item
window.editItem = async function(id) {
    try {
        currentDocId = id;
        const docRef = doc(db, 'inventory', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const item = docSnap.data();
            
            // Update modal title and button
            document.querySelector('.modal-content h2').textContent = 'Edit Item';
            document.querySelector('button[type="submit"]').textContent = 'Update Item';
            
            // Fill form with item data
            document.getElementById('name').value = item.name || '';
            document.getElementById('category').value = item.category || '';
            document.getElementById('specialCodeSearch').value = item.specialCode || '';
            document.getElementById('specialCode').value = item.specialCode || '';
            document.getElementById('quantity').value = item.quantity || '';
            document.getElementById('price').value = item.price || '';
            document.getElementById('description').value = item.description || '';
            document.getElementById('warranty').value = item.warranty || '';
            document.getElementById('brand').value = item.brand || '';
            
            // Show image preview if exists
            if (item.imageUrl) {
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${item.imageUrl}" style="max-width: 200px;">
                `;
            } else {
                document.getElementById('imagePreview').innerHTML = '';
            }
            
            // Show modal
            modal.style.display = 'block';
        } else {
            console.error('No such document!');
            alert('Error: Item not found');
        }
    } catch (error) {
        console.error('Error getting document:', error);
        alert('Error loading item data. Please try again.');
    }
};

// Delete item
window.deleteItem = async function(id) {
    const confirmDelete = confirm('Are you sure you want to delete this item?');
    if (!confirmDelete) return;
    
    try {
        const docRef = doc(db, 'inventory', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const item = docSnap.data();
            console.log('Found document to delete:', item);
            
            // Handle image deletion from Cloudinary if exists
            if (item.imageUrl) {
                try {
                    // Extract public ID from Cloudinary URL
                    const urlParts = item.imageUrl.split('/');
                    const filenameWithExtension = urlParts[urlParts.length - 1];
                    const publicId = filenameWithExtension.split('.')[0];
                    
                    // Generate timestamp and signature
                    const timestamp = Math.round(new Date().getTime() / 1000);
                    const apiSecret = 'CIP69qSf5hfgkKRfmmEbbMp48C0';
                    const apiKey = '481536226327482';
                    
                    // Create signature string
                    const signatureStr = `public_id=${publicId}&timestamp=${timestamp}${apiSecret}`;
                    const signature = await generateSignature(signatureStr);
                    
                    // Delete from Cloudinary with proper authentication
                    const response = await fetch('https://api.cloudinary.com/v1_1/dqsrrhxms/image/destroy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            public_id: publicId,
                            api_key: apiKey,
                            timestamp: timestamp,
                            signature: signature
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('Cloudinary deletion failed:', errorData);
                    }
                } catch (cloudinaryError) {
                    console.error('Cloudinary deletion error:', cloudinaryError);
                    // Continue with Firestore deletion even if Cloudinary fails
                }
            }
            
            // Delete the document from Firestore
            await deleteDoc(docRef);
            console.log('Document successfully deleted');
            
            // Refresh the items list
            fetchItems();
            alert('Item deleted successfully');
        } else {
            console.error('Document does not exist:', id);
            alert('Error: Item not found');
        }
    } catch (error) {
        console.error('Error deleting item:', error);
        alert('Error deleting item. Please try again.');
    }
};

// Bulk delete
window.bulkDelete = async function() {
    const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
    if (checkedBoxes.length === 0) return;

    const confirmDelete = confirm(`Are you sure you want to delete ${checkedBoxes.length} items?`);
    if (!confirmDelete) return;

    try {
        for (const checkbox of checkedBoxes) {
            await deleteDoc(doc(db, 'inventory', checkbox.value));
        }
        
        // Reset select all checkbox
        document.getElementById('selectAll').checked = false;
        
        // Hide bulk delete button
        document.getElementById('bulkDeleteBtn').style.display = 'none';
        
        // Refresh the inventory list
        fetchItems();
        
        alert('Selected items have been deleted successfully');
    } catch (error) {
        console.error('Error during bulk delete:', error);
        alert('Error deleting items. Please try again.');
    }
};

// Toggle select all
window.toggleSelectAll = function(e) {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
    updateBulkDeleteButton();
};

// Update bulk delete button visibility
window.updateBulkDeleteButton = function() {
    const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
    document.getElementById('bulkDeleteBtn').style.display = checkedBoxes.length > 0 ? 'inline-block' : 'none';
};

// Print inventory
window.printInventory = function() {
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    
    // Get current filters
    const categoryFilter = document.getElementById('categoryFilter').value;
    const stockFilter = document.getElementById('stockFilter').value;
    const searchQuery = document.getElementById('searchInput').value;
    
    // Create print content
    let printContent = `
        <html>
        <head>
            <title>Inventory Report</title>
            <style>
                body { font-family: Arial, sans-serif; }
                .print-header { text-align: center; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .filters { margin-bottom: 20px; }
                .timestamp { text-align: right; margin-top: 10px; font-size: 12px; }
                img { width: 50px; height: 50px; object-fit: cover; }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>Inventory Report</h1>
            </div>
            
            <div class="filters">
                <p><strong>Filters:</strong> 
                    ${categoryFilter ? `Category: ${categoryFilter}` : 'All Categories'} | 
                    ${stockFilter ? `Stock: ${stockFilter}` : 'All Stock'} |
                    ${searchQuery ? `Search: "${searchQuery}"` : 'No Search Filter'}
                </p>
                <p><strong>Total Items:</strong> ${filteredItems.length}</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>SL</th>
                        <th>Product ID</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Brand</th>
                        <th>Special Code</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Add table rows
    filteredItems.forEach((item, index) => {
        printContent += `
            <tr>
                <td>${index + 1}</td>
                <td>${item.productId || 'N/A'}</td>
                <td>${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}">` : 'No Image'}</td>
                <td>${item.name}</td>
                <td>${item.category}</td>
                <td>${item.brand || 'N/A'}</td>
                <td>${item.specialCode}</td>
                <td>${item.quantity}</td>
                <td>${formatCurrency(parseFloat(item.price))}</td>
                <td>${item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A'}</td>
            </tr>
        `;
    });
    
    // Close table and add timestamp
    printContent += `
                </tbody>
            </table>
            
            <div class="timestamp">
                <p>Generated on: ${new Date().toLocaleString()}</p>
            </div>
        </body>
        </html>
    `;
    
    // Write to the new window and print
    printWindow.document.open();
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Wait for images to load before printing
    printWindow.onload = function() {
        printWindow.print();
    };
};

// Form submit handler
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Add validation for required fields
    const name = document.getElementById('name').value.trim();
    const category = document.getElementById('category').value.trim();
    const specialCode = document.getElementById('specialCode').value.trim();
    const quantity = document.getElementById('quantity').value;
    const price = document.getElementById('price').value;

    // Check if required fields are filled
    if (!name || !category || !specialCode || !quantity || !price) {
        alert('Please fill in all required fields');
        return;
    }

    // Get image file
    const imageFile = document.getElementById('itemImage').files[0];
    
    try {
        let imageUrl = '';
        let productId = '';
        
        // If editing an existing item
        if (currentDocId) {
            // Get the current item data to check for existing image and product ID
            const docRef = doc(db, 'inventory', currentDocId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const currentItem = docSnap.data();
                
                // Keep existing product ID if available
                productId = currentItem.productId || generateId();
                
                // If there's a new image and the item already had an image, delete the old one
                if (imageFile && currentItem.imageUrl) {
                    try {
                        // Extract public ID from Cloudinary URL
                        const urlParts = currentItem.imageUrl.split('/');
                        const filenameWithExtension = urlParts[urlParts.length - 1];
                        const publicId = filenameWithExtension.split('.')[0];
                        
                        // Generate timestamp and signature
                        const timestamp = Math.round(new Date().getTime() / 1000);
                        const apiSecret = 'CIP69qSf5hfgkKRfmmEbbMp48C0';
                        const apiKey = '481536226327482';
                        
                        // Create signature string
                        const signatureStr = `public_id=${publicId}&timestamp=${timestamp}${apiSecret}`;
                        const signature = await generateSignature(signatureStr);
                        
                        // Delete from Cloudinary with proper authentication
                        const response = await fetch('https://api.cloudinary.com/v1_1/dqsrrhxms/image/destroy', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                public_id: publicId,
                                api_key: apiKey,
                                timestamp: timestamp,
                                signature: signature
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.text();
                            console.error('Cloudinary deletion failed:', errorData);
                        } else {
                            console.log('Previous image deleted successfully');
                        }
                    } catch (cloudinaryError) {
                        console.error('Cloudinary deletion error:', cloudinaryError);
                        // Continue with upload even if deletion fails
                    }
                }
                
                // If no new image, keep the existing URL
                if (!imageFile) {
                    imageUrl = currentItem.imageUrl || '';
                }
            }
        } else {
            // Generate new 6-digit product ID for new items
            productId = generateId();
        }
        
        // Upload new image if provided
        if (imageFile) {
            // Upload new image to Cloudinary
            const formData = new FormData();
            formData.append('file', imageFile);
            formData.append('upload_preset', 'sarowar');
            
            const response = await fetch(
                'https://api.cloudinary.com/v1_1/dqsrrhxms/image/upload',
                {
                    method: 'POST',
                    body: formData
                }
            );
            
            const data = await response.json();
            imageUrl = data.secure_url;
        }

        const itemData = {
            productId: productId, // Store the 6-digit product ID
            name: document.getElementById('name').value,
            category: document.getElementById('category').value,
            specialCode: document.getElementById('specialCode').value,
            quantity: parseInt(document.getElementById('quantity').value),
            price: parseFloat(document.getElementById('price').value),
            description: document.getElementById('description').value,
            warranty: document.getElementById('warranty').value,
            brand: document.getElementById('brand').value.trim(),
            createdAt: new Date().toISOString(),
            imageUrl: imageUrl
        };
        
        if (currentDocId) {
            await updateDoc(doc(db, 'inventory', currentDocId), itemData);
            currentDocId = null;
        } else {
            await addDoc(collection(db, 'inventory'), itemData);
        }
        
        closeModal();
        fetchItems();
        alert('Item saved successfully!');
    } catch (error) {
        console.error('Error saving item:', error);
        alert('Error saving item. Please try again.');
    }
});

// Pagination event listeners
prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        updatePagination();
        displayCurrentPage();
    }
});

nextPageBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        updatePagination();
        displayCurrentPage();
    }
});

// Image preview event listener
document.getElementById('itemImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('imagePreview');
    const reader = new FileReader();
    
    reader.onload = function(e) {
        preview.innerHTML = `<img src="${e.target.result}" style="max-width: 200px;">`;
    }
    
    if (file) {
        reader.readAsDataURL(file);
    }
});

// Filter event listeners
document.getElementById('categoryFilter').addEventListener('change', fetchItems);
document.getElementById('stockFilter').addEventListener('change', fetchItems);
document.getElementById('searchInput').addEventListener('input', fetchItems);
document.getElementById('dateFilter').addEventListener('change', fetchItems);
document.getElementById('selectAll').addEventListener('change', toggleSelectAll);

// Initialize the page
document.addEventListener('DOMContentLoaded', async () => {
    // Setup special code autocomplete
    setupSpecialCodeAutocomplete();
    
    // Setup category dropdown
    await setupCategoryScrollbar();
    
    // Load initial items
    fetchItems();
});
    </script>
</body>
</html>