<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="sidebar.css">
    <link rel="stylesheet" href="settings.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="main-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>IMS</h2>
            </div>
            <ul class="nav-links">
                <li>
                    <a href="dashboard.html" >
                        <i class="fas fa-home"></i>
                        Dashboard
                    </a>
                </li> <li>
                    <a href="pos.html">
                        <i class="fas fa-shopping-cart"></i>
                        Pos
                    </a>
                </li>
                <li>
                    <a href="electronics-pos.html">
                        <i class="fas fa-shopping-cart"></i>
                        E-Pos
                    </a>
                </li>
                <li>
                    <a href="inventory.html">
                        <i class="fas fa-box"></i>
                        Inventory
                    </a>
                </li>
                <li>
                    <a href="vat.html">
                        <i class="fas fa-percent"></i>
                        Tax
                    </a>
                </li>
                <li>
                    <a href="sales.html">
                        <i class="fas fa-store"></i>
                        Sales
                    </a>
                </li>
                <li>
                    <a href="user-sales.html">
                        <i class="fas fa-exclamation-triangle"></i>
                        User-Management
                    </a>
                </li>
                <li>
                    <a href="employee.html">
                        <i class="fas fa-bars"></i>
                        Employee
                    </a>
                </li>
                <li>
                    <a href="expenses.html">
                        <i class="fas fa fa-money-bill"></i>
                        Expenses
                    </a>
                </li>
                <a href="customers.html">
                    <i class="fas fa fa-users"></i>
                    Customer
                </a>
                <li><a href="ecommerce.html"><i class="fab fa-google-wallet"></i> Ecomerce</a></li>
                <li>
                    <a href="settings.html"  class="active">
                        <i class="fas fa-cog"></i>
                        Settings
                    </a>
                </li>
            </ul>
        </nav>

        <div class="main-content">
            <div class="pos-header">
                <h1>Settings</h1>
                <div class="header-actions">
                    <div class="header-date">
                        <i class="far fa-calendar-alt"></i>
                        <span id="currentDate">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="settings-tabs">
                <button class="tab-btn active" onclick="openTab(event, 'general')">General Settings</button>
                <button class="tab-btn" onclick="openTab(event, 'users')">User </button>
                <button class="tab-btn" onclick="openTab(event, 'categories')">Category Management</button>
            </div>
            <!-- Replace the settings-container content -->
            <div class="settings-container">
            
            <div id="generalTab" class="tab-content active">
                <div class="settings-grid">
                    <!-- Store Information Section -->
                    <div class="settings-section">
                        <h2><i class="fas fa-store"></i> Store Information</h2>
                        <div class="form-group">
                            <label>Store Name</label>
                            <input type="text" id="storeName" placeholder="Enter store name">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="storeAddress" placeholder="Enter store address"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Contact Number</label>
                            <input type="tel" id="storePhone" placeholder="Enter contact number">
                        </div>
                        <!-- Add this inside the Store Information Section, after the contact number field -->
                        <div class="form-group">
                            <label>Default Currency</label>
                            <select id="storeCurrency" class="form-control">
                                <option value="BDT">Bangladeshi Taka (৳)</option>
                                <option value="USD">US Dollar ($)</option>
                                <option value="EUR">Euro (€)</option>
                                <option value="GBP">British Pound (£)</option>
                                <option value="JPY">Japanese Yen (¥)</option>
                                <option value="INR">Indian Rupee (₹)</option>
                                <option value="CNY">Chinese Yuan (¥)</option>
                            </select>
                        </div>
                        <button class="save-btn" onclick="saveStoreInfo()">Save Information</button>
                    </div>
                    
                    <div class="settings-section">
                        <h2><i class="fas fa-bell"></i> Notifications</h2>
                        <div class="settings-toggle">
                            <label>Low Stock Alerts</label>
                            <label class="switch">
                                <input type="checkbox" id="lowStockAlert">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Low Stock Threshold</label>
                            <input type="number" id="lowStockThreshold" min="1" value="10">
                        </div>
                        <div class="settings-toggle">
                            <label>Daily Reports</label>
                            <label class="switch">
                                <input type="checkbox" id="dailyReports">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <button class="save-btn" onclick="saveNotificationSettings()">Save Settings</button>
                    </div>
                    
                    <div class="settings-section">
                        <h2><i class="fas fa-palette"></i> Appearance</h2>
                        <div class="theme-options">
                            <div class="theme-option" onclick="setTheme('light')">
                                <div class="theme-preview light"></div>
                                <span>Light</span>
                            </div>
                            <div class="theme-option" onclick="setTheme('dark')">
                                <div class="theme-preview dark"></div>
                                <span>Dark</span>
                            </div>
                            <div class="theme-option" onclick="setTheme('blue')">
                                <div class="theme-preview blue"></div>
                                <span>Blue</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- After the usersTab div -->
               
                <!-- Update the user form section -->
                
        </div>
        <!-- Add this after the existing category management section -->
        <div id="categoriesTab" class="tab-content">
            <div class="cat" id="cat">
            <div id="bhoot" class="settings-section">
                <h2><i class="fas fa-tags"></i> Category Management</h2>
                <div class="category-form">
                    <input type="text" id="categoryName" placeholder="Enter category name">
                    <button onclick="addCategory()">Add Category</button>
                </div>
                <div class="category-list">
                    <table id="categoryTable">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTableBody">
                            <!-- Categories will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- New E-Category Section -->
            
            <div class="settings-section">
                <h2><i class="fas fa-laptop"></i> E-Category Management</h2>
                <div class="category-form">
                    <input type="text" id="eCategoryName" placeholder="Enter e-category name">
                    <button onclick="addECategory()">Add E-Category</button>
                </div>
                <div class="category-list">
                    <table id="eCategoryTable">
                        <thead>
                            <tr>
                                <th>E-Category Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eCategoryTableBody">
                            <!-- E-Categories will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        <div id="usersTab" class="tab-content">
            <h2><i class="fas fa-users"></i> User</h2>
            <div class="settings-section">
                
                <div class="user-form">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="userName" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="fullName" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="userPassword" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="userPhone" placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="userRole">
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="cashier">Cashier</option>
                            <option value="e-cashier">E-Cashier</option>
                        </select>
                    </div>
                    <!-- Change this line in the user form -->
                    <button id="addUserBtn" class="save-btn" onclick="addUser()">Add User</button>
                </div>
                <div class="user-list">
                    <table id="userTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
           </div>

    <script type="module">
        import { setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
        from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const firebaseConfig = {
            apiKey: "AIzaSyBDz5gR_Zb-EOCga3G7pX3N2Rqwef4_hIw",
            authDomain: "supershop-bc036.firebaseapp.com",
            databaseURL: "https://supershop-bc036-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "supershop-bc036",
            storageBucket: "supershop-bc036.firebasestorage.app",
            messagingSenderId: "528401541608",
            appId: "1:528401541608:web:e1b352f95286170de09c5d",
            measurementId: "G-W4D9D0Z20S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;

        // Load categories
        window.loadCategories = async function() {
            const querySnapshot = await getDocs(collection(db, 'categories'));
            const tbody = document.getElementById('categoryTableBody');
            tbody.innerHTML = '';

            querySnapshot.forEach((doc) => {
                const category = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.name}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteCategory('${doc.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        // Add category
        window.addCategory = async function() {
            const categoryInput = document.getElementById('categoryName');
            const categoryName = categoryInput.value.trim();

            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }

            try {
                await addDoc(collection(db, 'categories'), {
                    name: categoryName,
                    createdAt: new Date().toISOString()
                });
                categoryInput.value = '';
                loadCategories();
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category');
            }
        };

        // Delete category
        window.deleteCategory = async function(categoryId) {
            if (confirm('Are you sure you want to delete this category?')) {
                try {
                    await deleteDoc(doc(db, 'categories', categoryId));
                    loadCategories();
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('Error deleting category');
                }
            }
        };

        // Initialize
        loadCategories();
        // Load store information
        // Update loadStoreInfo function
        window.loadStoreInfo = async function() {
            try {
                const storeSnapshot = await getDocs(collection(db, 'storeInfo'));
                if (!storeSnapshot.empty) {
                    const storeData = storeSnapshot.docs[0].data();
                    document.getElementById('storeName').value = storeData.name || '';
                    document.getElementById('storeAddress').value = storeData.address || '';
                    document.getElementById('storePhone').value = storeData.phone || '';
                    document.getElementById('storeCurrency').value = storeData.currency || 'BDT'; // Default to BDT
                }
            } catch (error) {
                console.error('Error loading store info:', error);
            }
        };
        // Save store information
        // Add this function to get currency symbol
        function getCurrencySymbol(currency) {
            const symbols = {
                'BDT': '৳',
                'USD': '$',
                'EUR': '€',
                'GBP': '£',
                'JPY': '¥',
                'INR': '₹',
                'CNY': '¥'
            };
            return symbols[currency] || currency;
        }
        
        // Update the saveStoreInfo function
        window.saveStoreInfo = async function() {
            const storeName = document.getElementById('storeName').value.trim();
            const storeAddress = document.getElementById('storeAddress').value.trim();
            const storePhone = document.getElementById('storePhone').value.trim();
            const storeCurrency = document.getElementById('storeCurrency').value;
        
            if (!storeName || !storeAddress || !storePhone) {
                alert('Please fill in all store information fields');
                return;
            }
        
            try {
                const storeSnapshot = await getDocs(collection(db, 'storeInfo'));
                const storeData = {
                    name: storeName,
                    address: storeAddress,
                    phone: storePhone,
                    currency: storeCurrency,
                    currencySymbol: getCurrencySymbol(storeCurrency),
                    updatedAt: new Date().toISOString()
                };
        
                if (storeSnapshot.empty) {
                    await addDoc(collection(db, 'storeInfo'), storeData);
                } else {
                    const storeDoc = storeSnapshot.docs[0];
                    await updateDoc(doc(db, 'storeInfo', storeDoc.id), storeData);
                }
        
                alert('Store information saved successfully');
                // Add activity log for currency change
                await addDoc(collection(db, 'inventoryActivities'), {
                    action: 'update',
                    type: 'currency',
                    details: `Currency changed to ${storeCurrency}`,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving store info:', error);
                alert('Error saving store information');
            }
        };
        // Initialize store info
        loadStoreInfo();
        // Update date
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        // Add these imports to your existing imports
import { getAuth, createUserWithEmailAndPassword, deleteUser } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { updatePassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { signInWithEmailAndPassword, reauthenticateWithCredential, EmailAuthProvider } 
from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
// Add this after the Firebase initialization
window.createDefaultAdmin = async function() {
    try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const adminExists = usersSnapshot.docs.some(doc => doc.data().role === 'admin');
        
        if (!adminExists) {
            const defaultAdmin = {
                email: 'admin@supershop.com',
                password: 'admin123',
                username: 'admin',
                fullName: 'System Admin',
                phone: '0000000000',
                role: 'admin'
            };

            // Create auth user
            const userCredential = await createUserWithEmailAndPassword(auth, defaultAdmin.email, defaultAdmin.password);
            
            // Add to Firestore
            await addDoc(collection(db, 'users'), {
                uid: userCredential.user.uid,
                username: defaultAdmin.username,
                fullName: defaultAdmin.fullName,
                email: defaultAdmin.email,
                phone: defaultAdmin.phone,
                role: defaultAdmin.role,
                createdAt: new Date().toISOString(),
                active: true
            });

            console.log('Default admin created successfully');
            alert('Default admin created with email: admin@supershop.com and password: admin123');
        }
    } catch (error) {
        console.error('Error creating default admin:', error);
    }
};

// Add this line after loadUsers() initialization
createDefaultAdmin();
const auth = getAuth(app);

// Load users
// Update the loadUsers function
window.loadUsers = async function() {
    const querySnapshot = await getDocs(collection(db, 'users'));
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';

    querySnapshot.forEach((doc) => {
        const user = doc.data();
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.fullName || ''}</td>
            <td>${user.email}</td>
            <td>${user.phone || ''}</td>
            <td>${user.role}</td>
            <td class="user-actions">
                <button class="edit-btn" onclick="editUser('${doc.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn" onclick="deleteUser('${doc.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
};
// Add edit user functionality
window.editUser = async function(userId) {
    try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (userDoc.exists()) {
            const userData = userDoc.data();
            
            // Populate form with user data
            document.getElementById('userName').value = userData.username;
            document.getElementById('fullName').value = userData.fullName;
            document.getElementById('userEmail').value = userData.email;
            document.getElementById('userPhone').value = userData.phone;
            document.getElementById('userRole').value = userData.role;
            
            // Change button text and functionality
            const addButton = document.getElementById('addUserBtn');
            addButton.textContent = 'Update User';
            addButton.onclick = () => updateUser(userId);
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        alert('Error loading user data');
    }
};

// Add update user functionality
window.updateUser = async function(userId) {
    const username = document.getElementById('userName').value.trim();
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const password = document.getElementById('userPassword').value;
    const phone = document.getElementById('userPhone').value.trim();
    const role = document.getElementById('userRole').value;

    if (!username || !fullName || !email || !phone) {
        alert('Please fill in all required fields');
        return;
    }

    try {
        const updateData = {
            username,
            fullName,
            email,
            phone,
            role,
            updatedAt: new Date().toISOString()
        };

        // Only update password if a new one is provided
        if (password && password.length >= 6) {
            // Get current user's email and prompt for current password
            const currentPassword = prompt("Please enter your current password to update user information:");
            if (!currentPassword) {
                throw new Error('Current password is required to update user information');
            }

            // Reauthenticate current user
            const user = auth.currentUser;
            if (user) {
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, password);
            }
            updateData.password = password;
        }

        await updateDoc(doc(db, 'users', userId), updateData);

        // Reset form and button
        document.getElementById('userName').value = '';
        document.getElementById('fullName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userPhone').value = '';
        document.getElementById('userRole').value = 'cashier';
        
        const addButton = document.getElementById('addUserBtn');
        addButton.textContent = 'Add User';
        addButton.onclick = addUser;

        loadUsers();
        alert('User updated successfully');
    } catch (error) {
        console.error('Error updating user:', error);
        if (error.code === 'auth/requires-recent-login') {
            alert('For security reasons, please log out and log back in before changing passwords.');
        } else {
            alert('Error updating user: ' + error.message);
        }
    }
};
// Update the addUser function
window.addUser = async function() {
    const isAdmin = await checkAdminAccess();
    if (!isAdmin) {
        alert('Only administrators can add users');
        return;
    }
    const username = document.getElementById('userName').value.trim();
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const password = document.getElementById('userPassword').value;
    const phone = document.getElementById('userPhone').value.trim();
    const role = document.getElementById('userRole').value;

    // Validation checks remain the same...
    try {
        // Check if username or email already exists
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const userExists = usersSnapshot.docs.some(doc => {
            const userData = doc.data();
            return userData.username === username || userData.email === email;
        });
        
        if (userExists) {
            alert('Username or email already exists');
            return;
        }
        const adminExists = usersSnapshot.docs.some(doc => {
            const userData = doc.data();
            return userData.role === 'admin';
        });
        
        if (role === 'admin') {
            const adminExists = usersSnapshot.docs.some(doc => {
                const userData = doc.data();
                return userData.role === 'admin';
            });
            
            if (adminExists) {
                alert('An admin user already exists. Only one admin is allowed.');
                return;
            }
        }
        // Create auth user
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid; // Get the UID from Authentication
        // Add user to Firestore with the same UID
        const userDocRef = doc(db, 'users', uid); // Use the UID as document ID
        await setDoc(userDocRef, {
            uid: uid,
            username: username,
            fullName: fullName,
            email: email,
            phone: phone,
            role: role,
            createdAt: new Date().toISOString(),
            active: true
        });
        // Clear form and reload users
        document.getElementById('userName').value = '';
        document.getElementById('fullName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userPhone').value = '';
        document.getElementById('userRole').value = 'cashier';
        loadUsers();
        alert('User registered successfully');
    } catch (error) {
        console.error('Error registering user:', error);
        alert(error.message);
    }
};

// Delete user function with admin check
window.deleteUser = async function(userId) {
    const isAdmin = await checkAdminAccess();
    if (!isAdmin) {
        alert('Only administrators can delete users');
        return;
    }

    if (confirm('Are you sure you want to delete this user?')) {
        try {
            // Check if user is the last admin
            const userDoc = await getDoc(doc(db, 'users', userId));
            const userData = userDoc.data();
            
            if (userData.role === 'admin') {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const adminCount = usersSnapshot.docs.filter(doc => 
                    doc.data().role === 'admin'
                ).length;
                
                if (adminCount <= 1) {
                    alert('Cannot delete the last admin user');
                    return;
                }
            }

            // Delete from Authentication
            try {
                const user = auth.currentUser;
                if (userData.uid === user.uid) {
                    alert('Cannot delete your own account while logged in');
                    return;
                }
            } catch (error) {
                console.error('Error checking current user:', error);
            }

            // Delete from Firestore
            await deleteDoc(doc(db, 'users', userId));
            loadUsers();
            alert('User deleted successfully');
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user: ' + error.message);
        }
    }
};
// Add user function with admin check
window.addUser = async function() {
    const isAdmin = await checkAdminAccess();
    if (!isAdmin) {
        alert('Only administrators can add users');
        return;
    }
    const username = document.getElementById('userName').value.trim();
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const password = document.getElementById('userPassword').value;
    const phone = document.getElementById('userPhone').value.trim();
    const role = document.getElementById('userRole').value;
    // Validation checks remain the same...
    try {
        // Create auth user first
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid; // Get the UID from Authentication
        // Add user to Firestore with the same UID
        const userDocRef = doc(db, 'users', uid); // Use the UID as document ID
        await setDoc(userDocRef, {
            uid: uid,
            username: username,
            fullName: fullName,
            email: email,
            phone: phone,
            role: role,
            createdAt: new Date().toISOString(),
            active: true
        });
        // Clear form and reload users
        document.getElementById('userName').value = '';
        document.getElementById('fullName').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userPhone').value = '';
        document.getElementById('userRole').value = 'cashier';
        loadUsers();
        alert('User registered successfully');
    } catch (error) {
        console.error('Error registering user:', error);
        alert(error.message);
    }
};
// Delete user function with admin check
window.deleteUser = async function(userId) {
    const isAdmin = await checkAdminAccess();
    if (!isAdmin) {
        alert('Only administrators can delete users');
        return;
    }

    if (confirm('Are you sure you want to delete this user?')) {
        try {
            // Check if user is the last admin
            const userDoc = await getDoc(doc(db, 'users', userId));
            const userData = userDoc.data();
            
            if (userData.role === 'admin') {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const adminCount = usersSnapshot.docs.filter(doc => 
                    doc.data().role === 'admin'
                ).length;
                
                if (adminCount <= 1) {
                    alert('Cannot delete the last admin user');
                    return;
                }
            }

            // Delete from Authentication
            try {
                const user = auth.currentUser;
                if (userData.uid === user.uid) {
                    alert('Cannot delete your own account while logged in');
                    return;
                }
            } catch (error) {
                console.error('Error checking current user:', error);
            }

            // Delete from Firestore
            await deleteDoc(doc(db, 'users', userId));
            loadUsers();
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
        }
    }
};

// Initialize users
loadUsers();
// Add these functions after your existing script code
// Load settings from Firestore
window.loadSettings = async function() {
    try {
        const settingsDoc = await getDocs(collection(db, 'settings'));
        settingsDoc.forEach((doc) => {
            const settings = doc.data();
            // Update notifications
            document.getElementById('lowStockAlert').checked = settings.lowStockAlert || false;
            document.getElementById('lowStockThreshold').value = settings.lowStockThreshold || 10;
            document.getElementById('dailyReports').checked = settings.dailyReports || false;
            
            // Update theme
            if (settings.theme) {
                setTheme(settings.theme);
            }
        });
    } catch (error) {
        console.error('Error loading settings:', error);
    }
};

// Save notification settings
window.saveNotificationSettings = async function() {
    try {
        const settings = {
            lowStockAlert: document.getElementById('lowStockAlert').checked,
            lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value),
            dailyReports: document.getElementById('dailyReports').checked,
            updatedAt: new Date().toISOString()
        };

        // Get existing settings document or create new one
        const settingsSnapshot = await getDocs(collection(db, 'settings'));
        if (settingsSnapshot.empty) {
            await addDoc(collection(db, 'settings'), settings);
        } else {
            const settingDoc = settingsSnapshot.docs[0];
            await updateDoc(doc(db, 'settings', settingDoc.id), settings);
        }

        alert('Notification settings saved successfully');
    } catch (error) {
        console.error('Error saving settings:', error);
        alert('Error saving settings');
    }
};

// Theme management
window.setTheme = async function(theme) {
    try {
        // Update UI
        document.querySelectorAll('.theme-option').forEach(option => {
            option.classList.remove('active');
        });
        document.querySelector(`.theme-option[onclick="setTheme('${theme}')"]`).classList.add('active');

        // Save to Firestore
        const settingsSnapshot = await getDocs(collection(db, 'settings'));
        if (settingsSnapshot.empty) {
            await addDoc(collection(db, 'settings'), { theme, updatedAt: new Date().toISOString() });
        } else {
            const settingDoc = settingsSnapshot.docs[0];
            await updateDoc(doc(db, 'settings', settingDoc.id), { 
                theme,
                updatedAt: new Date().toISOString()
            });
        }

        // Apply theme
        document.body.className = theme + '-theme';
    } catch (error) {
        console.error('Error saving theme:', error);
        alert('Error saving theme');
    }
};

// Initialize settings
loadSettings();
// Add this to your script section
// Add this function at the beginning of your script
// Update the checkAdminAccess function
window.checkAdminAccess = async function() {
    try {
        // Get current user from session storage
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        
        if (!currentUser) {
            return false;
        }

        // Check if user has admin role directly from session data
        return currentUser.role === 'admin';
    } catch (error) {
        console.error('Error checking admin access:', error);
        return false;
    }
};

// Modify the openTab function
window.openTab = async function(event, tabName) {
    // Only check admin access for users tab
    if (tabName === 'users') {
        const isAdmin = await checkAdminAccess();
        if (!isAdmin) {
            alert('Access denied. Only administrators can access user management.');
            return;
        }
    }

    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => {
        tab.classList.remove('active');
    });
    
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    const selectedTab = document.getElementById(tabName + 'Tab');
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    const selectedButton = event.currentTarget;
    if (selectedButton) {
        selectedButton.classList.add('active');
    }
};    </script>
<script type="module">
    // ... existing imports and configurations ...

    // Load e-categories
    window.loadECategories = async function() {
        const querySnapshot = await getDocs(collection(db, 'e-categories'));
        const tbody = document.getElementById('eCategoryTableBody');
        tbody.innerHTML = '';

        querySnapshot.forEach((doc) => {
            const category = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${category.name}</td>
                <td>
                    <button class="delete-btn" onclick="deleteECategory('${doc.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    };

    // Add e-category
    window.addECategory = async function() {
        const categoryInput = document.getElementById('eCategoryName');
        const categoryName = categoryInput.value.trim();

        if (!categoryName) {
            alert('Please enter an e-category name');
            return;
        }

        try {
            await addDoc(collection(db, 'e-categories'), {
                name: categoryName,
                createdAt: new Date().toISOString()
            });
            categoryInput.value = '';
            loadECategories();
        } catch (error) {
            console.error('Error adding e-category:', error);
            alert('Error adding e-category');
        }
    };

    // Delete e-category
    window.deleteECategory = async function(categoryId) {
        if (confirm('Are you sure you want to delete this e-category?')) {
            try {
                await deleteDoc(doc(db, 'e-categories', categoryId));
                loadECategories();
            } catch (error) {
                console.error('Error deleting e-category:', error);
                alert('Error deleting e-category');
            }
        }
    };

    // Add this to your initialization code
    loadECategories();

</script>


</body>
</html>