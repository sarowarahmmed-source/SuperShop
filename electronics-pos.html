<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electronics POS</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="electronics-pos.css">
    <link rel="stylesheet" href="pos.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Electronics POS</h3>
            <button class="close-sidebar" onclick="toggleSidebar()">Ã—</button>
        </div>
        <ul class="sidebar-menu">
            <li><a href="dashboard.html" ><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="pos.html"><i class="fas fa-shopping-cart"></i> Pos</a></li>
            <li><a href="electronics-pos.html"class="active"><i class="fas fa-shopping-cart"></i> E-Pos</a></li>
            <li><a href="inventory.html"><i class="fas fa-box"></i> Inventory</a></li>
            <li><a href="vat.html"><i class="fas fa-percent"></i> Tax</a></li>
            <li><a href="sales.html"><i class="fas fa-store"></i> Sales</a></li>
            <li><a href="user-sales.html"><i class="fas fa-exclamation-triangle"></i> User-Management</a></li>
            <li><a href="employee.html"><i class="fas fa-bars"></i> Employee</a></li>
            <li><a href="expenses.html"><i class="fas fa-money-bill-wave"></i> Expenses</a></li>
            <li><a href="customers.html"><i class="fas fa-users"></i> Customer</a></li>
            <li><a href="ecommerce.html"><i class="fab fa-google-wallet"></i> Ecomerce</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>

    <div class="pos-header">
        <button class="hamburger-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="search-filter-container">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Search products...">
            </div>
        </div>
    </div>
    <!-- Replace this static category tabs section -->
    <div class="category-tabs">
        <button class="category-tab active" data-category="all">All</button>
    </div>
   <!-- Add this after the subcategory filter div -->
<div class="sub">
    <select id="subcategoryFilter" class="subcategory-filter">
        <option value="">All Subcategories</option>
    </select>
    <!-- Add this after the view-toggle div -->
    <div class="view-toggle">
        <button class="active" data-view="grid">
            <i class="fas fa-th"></i> Grid
        </button>
        <button data-view="list">
            <i class="fas fa-list"></i> List
        </button>
    </div>
    <!-- Add pagination controls -->
   
</div>
    <div class="pos-containers" id="posCon">
        <div class="products-grid" id="productsGrid"></div>
        <!-- Replace the cart-section div -->
        <div class="cart-toggle-btn">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-item-count">0</span>
        </div>
        <div class="cart-section">
            <h2>Shopping Cart</h2>
            <div class="cart-items"></div>
            <div class="cart-total">
                <div class="total-breakdown">
                    <p>Subtotal: <span id="subtotal">0.00</span></p>
                    <p>VAT: <span id="vat">0.00</span></p>
                    <h3>Total: <span id="total">0.00</span></h3>
                </div>
                <button class="checkout-btn" onclick="checkout()">Checkout</button>
            </div>
        </div>
    </div>

    <div class="pagination-controls">
        <button id="prevPage" disabled><i class="fas fa-chevron-left"></i></button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
        <select id="pageSizeSelector" class="page-size-selector">
            <option value="12">12 per page</option>
            <option value="24">24 per page</option>
            <option value="50" selected>50 per page</option>
            <option value="100">100 per page</option>
        </select>
    </div>

<script>
    // Initialize cart toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        const cartToggleBtn = document.querySelector('.cart-toggle-btn');
        const cartSection = document.querySelector('.cart-section');

        if (cartToggleBtn && cartSection) {
            cartToggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                cartSection.classList.toggle('active');
            });
        }
    });
// Add this after your existing DOMContentLoaded event
document.addEventListener('DOMContentLoaded', function() {
    const viewToggleButtons = document.querySelectorAll('.view-toggle button');
    const productsGrid = document.getElementById('productsGrid');

    viewToggleButtons.forEach(button => {
        button.addEventListener('click', () => {
            const view = button.getAttribute('data-view');
            
            // Update buttons
            viewToggleButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Update grid view
            productsGrid.classList.remove('grid-view', 'list-view');
            productsGrid.classList.add(`${view}-view`);
        });
    });
});
    // Add the toggleSidebar function globally
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    };
</script>

<script type="module">
    // Remove the existing toggleSidebar function from here
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc, deleteDoc } 
        from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBDz5gR_Zb-EOCga3G7pX3N2Rqwef4_hIw",
            authDomain: "supershop-bc036.firebaseapp.com",
            databaseURL: "https://supershop-bc036-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "supershop-bc036",
            storageBucket: "supershop-bc036.firebasestorage.app",
            messagingSenderId: "528401541608",
            appId: "1:528401541608:web:e1b352f95286170de09c5d",
            measurementId: "G-W4D9D0Z20S"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
window.collection = collection;
window.doc = doc;
window.getDoc = getDoc;
window.updateDoc = updateDoc;
window.addDoc = addDoc;
window.getDocs = getDocs; 

 // Add these pagination variables after your Firebase initialization
 let currentPage = 1;
    let productsPerPage = 50; // Adjust this number based on your preference
    let totalProducts = 0;
    let filteredProducts = [];
    
    // Update the loadProducts function to support pagination
    async function loadProducts(category = 'all', searchTerm = '') {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            productsGrid.className = `products-grid ${currentView}-view`;
            
            try {
                // Get all e-categories
                const eCategoriesSnapshot = await getDocs(collection(db, 'e-categories'));
                const eCategories = new Set();
                eCategoriesSnapshot.forEach(doc => {
                    eCategories.add(doc.data().name);
                });
    
                // Get products
                const q = collection(db, 'inventory');
                const querySnapshot = await getDocs(q);
                
                // Reset filtered products array
                filteredProducts = [];
    
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    const productId = doc.id;
                    product.quantity = parseInt(product.quantity) || 0;
        
                    // Check if product belongs to e-categories
                    const isElectronicsProduct = eCategories.has(product.category);
                    
                    // Search condition
                    const searchMatch = !searchTerm || 
                        productId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (product.specialCode && product.specialCode.toLowerCase().includes(searchTerm.toLowerCase()));
    
                    // Category condition
                    const categoryMatch = category === 'all' ? isElectronicsProduct : product.category === category;
    
                    if (categoryMatch && searchMatch) {
                        // Add to filtered products array instead of directly to grid
                        filteredProducts.push({product, id: productId});
                    }
                });
                
                // Update total products count
                totalProducts = filteredProducts.length;
                
                // Update pagination controls
                updatePaginationControls();
                
                // Display current page
                displayCurrentPage();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        window.loadProducts = loadProducts; // Make loadProducts available globally
    
    // Add this function to display the current page of products
    function displayCurrentPage() {
        const productsGrid = document.getElementById('productsGrid');
        productsGrid.innerHTML = '';
        
        // Calculate start and end indices for current page
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = Math.min(startIndex + productsPerPage, totalProducts);
        
        // Display products for current page
        for (let i = startIndex; i < endIndex; i++) {
            const {product, id} = filteredProducts[i];
            const productCard = createProductCard(product, id);
            productsGrid.appendChild(productCard);
        }
        
        // Update page info text
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${Math.ceil(totalProducts / productsPerPage) || 1}`;
    }
    
    // Add this function to update pagination controls
    function updatePaginationControls() {
        const totalPages = Math.ceil(totalProducts / productsPerPage) || 1;
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');
        
        // Update prev button state
        prevButton.disabled = currentPage <= 1;
        
        // Update next button state
        nextButton.disabled = currentPage >= totalPages;
    }
    
    // Add these event listeners for pagination buttons
    document.addEventListener('DOMContentLoaded', function() {
        // ... existing DOMContentLoaded code ...
        
        // Add pagination button event listeners
        document.getElementById('prevPage').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
                updatePaginationControls();
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', function() {
            const totalPages = Math.ceil(totalProducts / productsPerPage) || 1;
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPage();
                updatePaginationControls();
            }
        });
        document.getElementById('pageSizeSelector').addEventListener('change', function() {
            productsPerPage = parseInt(this.value);
            currentPage = 1; // Reset to first page when changing page size
            displayCurrentPage();
            updatePaginationControls();
        });
    });
    

        // Update the getVatRate function
        async function getVatRate(specialCode) {
    try {
        const vatRulesRef = collection(db, 'vatRules');
        const querySnapshot = await getDocs(vatRulesRef);
        let vatRate = 0;

        querySnapshot.forEach((doc) => {
            const rule = doc.data();
            if (rule.specialCode === specialCode) {
                vatRate = rule.vatPercentage / 100;
            }
        });
        return vatRate;
    } catch (error) {
        console.error('Error fetching VAT rate:', error);
        return 0;
    }
}

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
       
      

        let currentCurrency = 'à§³';
        let currentCurrencyCode = 'BDT';
        window.currentCurrency = currentCurrency;
window.currentCurrencyCode = currentCurrencyCode;
        // Add the currency loading function
        async function loadCurrencySettings() {
            try {
                const storeSnapshot = await getDocs(collection(db, 'storeInfo'));
                if (!storeSnapshot.empty) {
                    const storeData = storeSnapshot.docs[0].data();
                    currentCurrency = storeData.currencySymbol || 'à§³';
                    currentCurrencyCode = storeData.currency || 'BDT';
                }
            } catch (error) {
                console.error('Error loading currency settings:', error);
            }
        }// Add after loadCurrencySettings()
        function initializeCartDisplay() {
            document.getElementById('subtotal').textContent = formatCurrency(0);
            document.getElementById('vat').textContent = formatCurrency(0);
            document.getElementById('total').textContent = formatCurrency(0);
        }
        // Call this after loading currency settings
        loadCurrencySettings().then(() => {
            initializeCartDisplay();
        });
        // Inside your module script, after defining formatCurrency
        function formatCurrency(amount) {
            return `${amount.toFixed(2)}${currentCurrency}`;
        }
        // Make it globally available
        window.formatCurrency = formatCurrency;  loadCurrencySettings();
        // First, add this function to load categories from Firestore
        async function loadCategories() {
            const categoryTabs = document.querySelector('.category-tabs');
            categoryTabs.innerHTML = '<button class="category-tab active" data-category="all">All</button>';
        
            try {
                const querySnapshot = await getDocs(collection(db, 'e-categories'));
                querySnapshot.forEach((doc) => {
                    const category = doc.data();
                    const button = document.createElement('button');
                    button.className = 'category-tab';
                    button.setAttribute('data-category', category.name);
                    button.textContent = category.name;
                    categoryTabs.appendChild(button);
                });
        // Add this in your module script section, after Firebase initialization
window.db = db; // Make db accessible globally
window.collection = collection;
window.doc = doc;
window.getDoc = getDoc;
window.updateDoc = updateDoc;
window.addDoc = addDoc;
// Update the form event listener in the non-module script section
document.getElementById('customerForm').addEventListener('submit', function(e) {
    handleFormSubmission(e);
});
        
                // Reattach event listeners after loading categories
                attachCategoryEventListeners();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        // Update the event listener attachment function
        function attachCategoryEventListeners() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelector('.category-tab.active').classList.remove('active');
                    e.target.classList.add('active');
                    const category = e.target.dataset.category;
                    loadProducts(category);
                });
            });
        }
        // Modify the initialization part of your script
        // Add this after initializing Firebase
        loadCategories();
     
        // Add this after your Firebase initialization
        let currentView = 'grid';
        // Add this after your Firebase initialization and before the event listeners
        
        function createProductCard(product, id) {
            // Convert price to number and handle potential undefined/null values
            const price = parseFloat(product.price) || 0;
            const stock = parseInt(product.quantity) || 0;
            
            const card = document.createElement('div');
            card.className = 'product-card';
            // Add click event for showing details
            card.onclick = () => showProductDetails(product, id);
            // Cart functionality
            let cart = [];
            // Update the addToCart function
            window.addToCart = async function(id, name, price, quantity, stock) {
                const existingItem = cart.find(item => item.id === id);
                // Get product details for VAT
                const productRef = doc(db, 'inventory', id);
                const productDoc = await getDoc(productRef);
                const specialCode = productDoc.data()?.specialCode || '';
                
                if (existingItem) {
                    if (existingItem.quantity + quantity <= stock) {
                        existingItem.quantity += quantity;
                        existingItem.specialCode = specialCode;
                    } else {
                        alert(`Only ${stock} items available in stock!`);
                        existingItem.quantity = stock;
                    }
                } else {
                    if (quantity <= stock) {
                        cart.push({ id, name, price, quantity, stock, specialCode });
                    } else {
                        alert(`Only ${stock} items available in stock!`);
                        cart.push({ id, name, price, quantity: stock, stock, specialCode });
                    }
                }
                
                updateCartDisplay();
            };
            window.updateCartQuantity = function(id, change) {
                const item = cart.find(item => item.id === id);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) {
                        removeFromCart(id);
                    } else {
                        updateCartDisplay();
                    }
                }
            };
            
            // Update the updateCartDisplay function
            async function updateCartDisplay() {
    const cartItems = document.querySelector('.cart-items');
    const cartCount = document.querySelector('.cart-item-count');
    cartItems.innerHTML = '';
    let subtotal = 0;
    let totalItems = 0;
    let totalVat = 0;

    for (const item of cart) {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        totalItems += item.quantity;

        // Calculate VAT for this item
        const vatRate = await getVatRate(item.specialCode);
        const itemVat = itemTotal * vatRate;
        totalVat += itemVat;

        const itemElement = document.createElement('div');
        itemElement.className = 'cart-item';
        // Store special code as data attribute
        itemElement.setAttribute('data-special-code', item.specialCode || '');
        
        itemElement.innerHTML = `
            <div class="cart-item-details">
                <h4>${item.name}</h4>
                <p>${formatCurrency(item.price)} Ã— ${item.quantity}</p>
                <p class="vat-info">VAT (${(vatRate * 100).toFixed(1)}%): ${formatCurrency(itemVat)}</p>
            </div>
            <div class="cart-item-actions">
                <div class="cart-quantity-control">
                    <button onclick="updateCartQuantity('${item.id}', -1)">-</button>
                    <span>${item.quantity}</span>
                    <button onclick="updateCartQuantity('${item.id}', 1)">+</button>
                </div>
                <span>${formatCurrency(itemTotal)}</span>
                <button onclick="removeFromCart('${item.id}')" class="remove-item">Ã—</button>
            </div>
        `;
        cartItems.appendChild(itemElement);
    }

    // Update totals
    cartCount.textContent = totalItems;
    const total = subtotal + totalVat;
    
    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('vat').textContent = formatCurrency(totalVat);
    document.getElementById('total').textContent = formatCurrency(total);
}
            window.removeFromCart = function(id) {
                cart = cart.filter(item => item.id !== id);
                updateCartDisplay();
            };
            
            window.clearCart = function() {
                cart = [];
                updateCartDisplay();
            };
            card.innerHTML = `
                <div class="product-image">
                    ${product.imageUrl ? 
                        `<img src="${product.imageUrl}" alt="${product.name}">` : 
                        '<div class="no-image"><i class="fas fa-image"></i></div>'}
                </div>
                
                <div class="product-info">
                    
                    <h3>${product.name}</h3>
                    
                    <div class="specs-badges">
                        ${product.specs ? product.specs.map(spec => 
                            `<span class="specs-badge">${spec}</span>`).join('') : ''}
                    </div>
                   <div class="detail">
                    <p class="price">${formatCurrency(price)}</p>
                     ${product.warranty ? 
                        `<div class="warranty-info"><i class="fas fa-shield-alt"></i> ${product.warranty}</div>` : ''}
                    <p class="stock">Stock: ${stock}</p></div>
                </div>
                <button class="add-to-cart" onclick="event.stopPropagation(); addToCart('${id}', '${product.name}', ${price}, 1, ${stock})" ${stock <= 0 ? 'disabled' : ''}>
                    ${stock <= 0 ? 'Out of Stock' : 'Add to Cart'}
                </button>
            `;
            return card;
        }
        // Add these functions after your existing script
        // Find the showProductDetails function and update the product-meta div content
        window.showProductDetails = function(item, docId) {
            const modal = document.getElementById('productModal');
            const details = document.getElementById('productDetails');
            
            details.innerHTML = `
                <div class="product-details">
                    <div class="product-details-header">
                        <div class="product-image-container">
                            ${item.imageUrl ? 
                                `<img src="${item.imageUrl}" alt="${item.name}" class="product-details-image">` : 
                                '<div class="no-image"><i class="fas fa-image"></i></div>'
                            }
                        </div>
                        <div class="product-header-info">
                            <h2>${item.name}</h2>
                            <div class="product-meta">
                                <p><strong>Product ID:</strong> ${docId || 'N/A'}</p>
                                <p><strong>Category:</strong> ${item.category}</p>
                                <p><strong>Special Code:</strong> ${item.specialCode || 'N/A'}</p>
                                <p><strong>Stock:</strong> ${item.quantity} units</p>
                              <p><strong>Price:</strong> ${formatCurrency(parseFloat(item.price))}</p>
                                ${item.warranty ? 
                                    `<p><strong>Warranty:</strong> <i class="fas fa-shield-alt"></i> ${item.warranty}</p>` : 
                                    '<p><strong>Warranty:</strong> No warranty information available</p>'
                                }
                            </div>
                            <div class="product-actions">
                                <div class="quantity-control">
                                    <button onclick="updateQuantity('${docId}', -1)">-</button>
                                    <input type="number" id="quantity-${docId}" value="1" min="1" max="${item.quantity}">
                                    <button onclick="updateQuantity('${docId}', 1)">+</button>
                                </div>
                                <button class="add-to-cart" onclick="addToCartFromModal('${docId}', '${item.name}', ${item.price})">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="product-description-section">
                        <h3>Description:</h3>
                        <p>${item.description || 'No description available'}</p>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        };
        
        window.closeProductModal = function() {
            document.getElementById('productModal').style.display = 'none';
        };
        
        window.updateQuantity = function(docId, change) {
            const input = document.getElementById(`quantity-${docId}`);
            let value = parseInt(input.value) + change;
            value = Math.max(1, Math.min(value, parseInt(input.max)));
            input.value = value;
        };
        window.addToCartFromModal = async function(id, name, price) {
            try {
                // Get current stock from inventory
                const productRef = window.doc(window.db, 'inventory', id);
                const productDoc = await window.getDoc(productRef);
                
                if (!productDoc.exists()) {
                    throw new Error('Product not found');
                }
                
                const stock = parseInt(productDoc.data().quantity) || 0;
                const quantity = parseInt(document.getElementById(`quantity-${id}`).value);
                
                // Pass stock to addToCart
                addToCart(id, name, price, quantity, stock);
                closeProductModal();
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('Error adding item to cart. Please try again.');
            }
        };
        // Event Listeners

        function updateSubcategories(category) {
            const subcategorySelect = document.getElementById('subcategoryFilter');
            subcategorySelect.innerHTML = '<option value="">All Subcategories</option>';

            if (category !== 'all' && electronicsCategories[category]) {
                electronicsCategories[category].forEach(sub => {
                    subcategorySelect.innerHTML += `<option value="${sub}">${sub}</option>`;
                });
            }
        }

        document.getElementById('subcategoryFilter').addEventListener('change', (e) => {
            const category = document.querySelector('.category-tab.active').dataset.category;
            loadProducts(category, e.target.value);
        });
        // Update the search input event listener
        document.getElementById('searchInput').addEventListener('input', debounce((e) => {
            const category = document.querySelector('.category-tab.active').dataset.category;
            const searchTerm = e.target.value.trim();
            loadProducts(category, searchTerm);
        }, 300));
        // Initial load
        loadProducts();
    </script>

    <!-- Add Product Details Modal -->
    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <button class="product-modal-close" onclick="closeProductModal()">&times;</button>
            <div id="productDetails"></div>
        </div>
    </div>
    <!-- Existing checkout modal below -->
    <div id="checkoutModal" class="product-modal">
        <div class="product-modal-content">
            <button class="product-modal-close" onclick="closeCheckoutModal()">&times;</button>
            <div class="checkout-form">
                <h2>Customer Details</h2>
                <form id="customerForm">                    <div class="form-group">
                        <label for="customerName">Customer Name*</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone Number*</label>
                        <input type="tel" id="customerPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Email</label>
                        <input type="email" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Address</label>
                        <textarea id="customerAddress"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">Payment Method*</label>
                        <select id="paymentMethod" required onchange="handlePaymentMethodChange()">
                            <option value="#">Select</option>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="online">Online</option>
                            <option value="due">Due</option>
                        </select>
                    </div>
                    <div id="paymentDetails" class="payment-details">
                        <!-- Dynamic payment fields will be inserted here -->
                    </div>
                    <!-- Update the checkout modal form groups -->
                    <div class="form-group">
                        <label>Total Amount: <span id="modalTotal">0.00</span></label>
                    </div>
                    <div class="form-group">
                        <label for="paidAmount">Paid Amount*</label>
                        <input type="number" id="paidAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Due Amount: <span id="dueAmount">0.00</span></label>
                    </div>
                    <button type="submit" class="checkout-submit-btn">Complete Purchase</button>
                </form>
            </div>
        </div>
    </div>
    <script>
    // Update the checkout function
    // Update the checkout function
    window.checkout = function() {
        const cartItems = document.querySelectorAll('.cart-items .cart-item');
        if (cartItems.length === 0) {
            alert('Cart is empty!');
            return;
        }
        const modal = document.getElementById('checkoutModal');
        const totalAmount = parseFloat(document.getElementById('total').textContent.replace(window.currentCurrency, ''));
        document.getElementById('modalTotal').textContent = window.formatCurrency(totalAmount);
        document.getElementById('dueAmount').textContent = window.formatCurrency(0);
        modal.style.display = 'block';
    };
    
    // Add the missing closeCheckoutModal function
    window.closeCheckoutModal = function() {
        document.getElementById('checkoutModal').style.display = 'none';
    };
    
    window.getPaymentDetails = function(method) {
        switch(method) {
            case 'card':
                return {
                    cardNumber: document.getElementById('cardNumber')?.value || '',
                    cardName: document.getElementById('cardName')?.value || ''
                };
            case 'online':
                return {
                    transactionId: document.getElementById('transactionId')?.value || ''
                };
            case 'due':
                return {
                    dueDate: document.getElementById('dueDate')?.value || ''
                };
            default:
                return {};
        }
    };
    
    window.getPaymentDetails = function(method) {
        switch(method) {
            case 'card':
                return {
                    cardNumber: document.getElementById('cardNumber')?.value || '',
                    cardName: document.getElementById('cardName')?.value || ''
                };
            case 'online':
                return {
                    transactionId: document.getElementById('transactionId')?.value || ''
                };
            case 'due':
                return {
                    dueDate: document.getElementById('dueDate')?.value || ''
                };
            default:
                return {};
        }
    };
    
    // Update the paid amount event listener
    document.getElementById('paidAmount').addEventListener('input', function() {
        const total = parseFloat(document.getElementById('modalTotal').textContent.replace(currentCurrency, ''));
        const paid = parseFloat(this.value) || 0;
        const due = total - paid;
        document.getElementById('dueAmount').textContent = formatCurrency(due);
    });
    
    window.handlePaymentMethodChange = function() {
        const method = document.getElementById('paymentMethod').value;
    const detailsDiv = document.getElementById('paymentDetails');
    const paidAmountInput = document.getElementById('paidAmount');
    const modalTotalElement = document.getElementById('modalTotal');
    const totalAmount = parseFloat(modalTotalElement.textContent.replace(window.currentCurrency, ''));

    // Auto-fill paid amount for cash payments
    if (method === 'cash') {
        paidAmountInput.value = totalAmount;
        paidAmountInput.readOnly = true;
        // Trigger the input event to update the due amount
        const event = new Event('input', { bubbles: true });
        paidAmountInput.dispatchEvent(event);
    } else {
        paidAmountInput.value = '';
        paidAmountInput.readOnly = false;
        document.getElementById('dueAmount').textContent = window.formatCurrency(totalAmount);
    }

    switch(method) {
        case 'card':
            detailsDiv.innerHTML = `
                <div class="form-group">
                    <label for="cardNumber">Card Number*</label>
                    <input type="text" id="cardNumber" required>
                </div>
                <div class="form-group">
                    <label for="cardName">Name on Card*</label>
                    <input type="text" id="cardName" required>
                </div>
            `;
            break;
            case 'online':
                detailsDiv.innerHTML = `
                    <div class="form-group">
                        <label for="transactionId">Transaction ID*</label>
                        <input type="text" id="transactionId" required>
                    </div>
                `;
                break;
            case 'due':
                detailsDiv.innerHTML = `
                    <div class="form-group">
                        <label for="dueDate">Due Date*</label>
                        <input type="date" id="dueDate" required>
                    </div>
                `;
                break;
            default:
                detailsDiv.innerHTML = '';
        }
    };
    // Calculate due amount
    document.getElementById('paidAmount').addEventListener('input', function() {
        
        const total = parseFloat(document.getElementById('modalTotal').textContent);
        const paid = parseFloat(this.value) || 0;
        const due = total - paid;
        document.getElementById('dueAmount').textContent = due.toFixed(2);
    });
   // Inside the handleFormSubmission function, update the sale data and Firestore save logic
   window.handleFormSubmission = async function(e) {
    e.preventDefault();
    try {
        const storeSnapshot = await window.getDocs(window.collection(window.db, 'storeInfo'));
        const storeInfo = storeSnapshot.docs[0]?.data() || {
            currencySymbol: window.currentCurrency || 'à§³',
            currency: window.currentCurrencyCode || 'BDT'
        };

        // Generate a random 6-digit sale ID
        const saleId = Math.floor(100000 + Math.random() * 900000).toString();

        // Get cart items with total calculation for each item
        const cartItems = Array.from(document.querySelectorAll('.cart-items .cart-item')).map(item => {
        const productCard = document.querySelector(`[onclick*="addToCart('${item.querySelector('.cart-item-details h4').textContent}"]`)?.closest('.product-card');
        const vatInfo = item.querySelector('.vat-info')?.textContent || '';
        const vatMatch = vatInfo.match(/VAT.*?:\s*([\d.]+)/);
        
        return {
            id: item.querySelector('button[onclick*="removeFromCart"]')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1] || '',
            name: item.querySelector('.cart-item-details h4')?.textContent || '',
            quantity: parseInt(item.querySelector('.cart-quantity-control span')?.textContent) || 0,
            price: parseFloat(item.querySelector('.cart-item-details p')?.textContent?.replace(/[^0-9.]/g, '')) || 0,
            total: parseFloat(item.querySelector('.cart-item-actions span')?.textContent?.replace(/[^0-9.]/g, '')) || 0,
            warranty: productCard?.querySelector('.warranty-info')?.textContent?.trim() || 'No Warranty',
            vat: parseFloat(vatMatch?.[1]) || 0,
            specialCode: item.getAttribute('data-special-code') || '' 
        };
        });

        if (cartItems.length === 0) {
            throw new Error('Cart is empty');
        }

        // Get all the required amounts
        const totalAmount = parseFloat(document.getElementById('subtotal').textContent.replace(currentCurrency, '')) || 0;
        const totalVat = parseFloat(document.getElementById('vat').textContent.replace(currentCurrency, '')) || 0;
        const grandTotal = parseFloat(document.getElementById('modalTotal').textContent.replace(currentCurrency, '')) || 0;
        const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        
        // Create sale data object with explicit type and source system
        const saleData = {
            saleId: saleId,
            items: cartItems,
            totalAmount: totalAmount,
            totalVat: totalVat,
            grandTotal: grandTotal,
            timestamp: new Date().toISOString(),
            username: currentUser?.username || 'Guest',
            saleType: 'electronics', // Explicitly set sale type
            sourceSystem: 'electronics-pos', // Explicitly set source system
            storeInfo: {
                currency: storeInfo.currency,
                currencySymbol: storeInfo.currencySymbol
            },
            customer: {
                name: document.getElementById('customerName').value.trim() || '',
                phone: document.getElementById('customerPhone').value.trim() || '',
                email: document.getElementById('customerEmail').value.trim() || null,
                address: document.getElementById('customerAddress').value.trim() || null
            },
            dueAmount:grandTotal-paidAmount,
            payment: {
                method: document.getElementById('paymentMethod').value || 'cash',
                paid: paidAmount,
                due: grandTotal - paidAmount,
                details: window.getPaymentDetails(document.getElementById('paymentMethod').value) || {}
            }
        };

        console.log("Sale data being saved:", saleData); // Add this for debugging
        
        // Save to Firestore and update inventory
        const docRef = await window.addDoc(window.collection(window.db, 'sales'), saleData);
        console.log("Sale saved with ID:", docRef.id); // Add this for debugging

        // Update inventory and generate invoice
        for (const item of cartItems) {
            const productRef = window.doc(window.db, 'inventory', item.id);
            const productDoc = await window.getDoc(productRef);
            
            if (!productDoc.exists()) {
                throw new Error(`Product ${item.name} not found in inventory`);
            }
            
            const currentQuantity = productDoc.data().quantity || 0;
            if (currentQuantity < item.quantity) {
                throw new Error(`Insufficient stock for ${item.name}`);
            }
            
            await window.updateDoc(productRef, { 
                quantity: currentQuantity - item.quantity 
            });
        }
        window.generateInvoice = function(saleData) {
            const invoiceWindow = window.open('', '_blank');
        const currencySymbol = saleData.storeInfo.currencySymbol || 'à§³';
        const currencyCode = saleData.storeInfo.currency || 'BDT';
    const invoiceHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Invoice #${saleData.saleId}</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
                .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
                .company-info { text-align: left; }
                .invoice-meta { text-align: right; }
                .invoice-title { font-size: 24px; color: #333; margin-bottom: 10px; }
                .customer-details { margin-bottom: 30px; }
                .invoice-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                .invoice-table th, .invoice-table td { 
                    padding: 12px; 
                    border: 1px solid #ddd; 
                    text-align: left; 
                }
                .invoice-table th { background: #f8f8f8; }
                .totals { float: right; margin-top: 20px; text-align: right; }
                .totals p { margin: 5px 0; }
                .totals .grand-total { 
                    font-size: 1.2em; 
                    font-weight: bold; 
                    color: #333; 
                    border-top: 2px solid #333;
                    padding-top: 10px;
                }
                .signature-section { 
                    margin-top: 100px;
                    display: flex;
                    justify-content: space-between;
                    clear: both;
                }
                .signature-line {
                    width: 200px;
                    border-top: 1px solid #000;
                    margin-top: 10px;
                    text-align: center;
                    padding-top: 5px;
                }
                .payment-info { 
                    margin: 20px 0;
                    clear: both;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                }
                .vat-info { 
                    color: #666;
                    font-style: italic;
                }
                @media print {
                    body { margin: 0; padding: 10px; }
                    .no-print { display: none; }
                    .invoice-table { page-break-inside: avoid; }
                    .signature-section { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="invoice-header">
                 <div class="customer-details">
                <h3>Bill To:</h3>
                <p><strong>Name:</strong> ${saleData.customer.name}</p>
                <p><strong>Phone:</strong> ${saleData.customer.phone}</p>
                ${saleData.customer.email ? `<p><strong>Email:</strong> ${saleData.customer.email}</p>` : ''}
                ${saleData.customer.address ? `<p><strong>Address:</strong> ${saleData.customer.address}</p>` : ''}
            </div>
                <div class="invoice-meta">
                    <p><strong>Invoice #:</strong> ${saleData.saleId}</p>
                    <p><strong>Date:</strong> ${new Date(saleData.timestamp).toLocaleDateString()}</p>
                    <p><strong>Time:</strong> ${new Date(saleData.timestamp).toLocaleTimeString()}</p>
                    <p><strong>Currency:</strong> ${currencyCode}</p>
                </div>
            </div>

            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Item Description</th>
                        <th>Unit Price (${currencyCode})</th>
                        <th>Quantity</th>
                        <th>VAT Rate</th>
                        <th>VAT Amount (${currencyCode})</th>
                        <th>Total (${currencyCode})</th>
                    </tr>
                </thead>
                <tbody>
                    ${saleData.items.map(item => {
                        const itemSubtotal = item.price * item.quantity;
                        const vatRate = (item.vat / itemSubtotal * 100).toFixed(1);
                        return `
                            <tr>
                                <td>${item.name}</td>
                                <td>${currencySymbol} ${item.price.toFixed(2)}</td>
                                <td>${item.quantity}</td>
                                <td>${vatRate}%</td>
                                <td>${currencySymbol} ${item.vat.toFixed(2)}</td>
                                <td>${currencySymbol} ${(itemSubtotal + item.vat).toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="totals">
                <p>Subtotal: ${currencySymbol} ${saleData.totalAmount.toFixed(2)}</p>
                <p>Total VAT: ${currencySymbol} ${saleData.totalVat.toFixed(2)}</p>
                <p class="grand-total">Grand Total: ${currencySymbol} ${saleData.grandTotal.toFixed(2)}</p>
                <p>Amount Paid: ${currencySymbol} ${saleData.payment.paid.toFixed(2)}</p>
                <p>Balance Due: ${currencySymbol} ${saleData.payment.due.toFixed(2)}</p>
            </div>
            <div class="payment-info">
                <h3>Payment Details</h3>
                <p><strong>Method:</strong> ${saleData.payment.method.toUpperCase()}</p>
                ${saleData.payment.method !== 'cash' ? `
                    <p>${Object.entries(saleData.payment.details).map(([key, value]) => 
                        `<strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}`
                    ).join('<br>')}</p>
                ` : ''}
            </div>

            <div class="signature-section">
                <div>
                    <div class="signature-line">Customer Signature</div>
                </div>
                <div>
                    <div class="signature-line">Authorized Signature</div>
                </div>
            </div>

            <button class="no-print" onclick="window.print()" style="margin-top: 20px; padding: 10px;">Print Invoice</button>
        </body>
        </html>
    `;
    
    invoiceWindow.document.write(invoiceHTML);
        invoiceWindow.document.close();
        setTimeout(() => invoiceWindow.print(), 500);
};

// Update the success part of handleFormSubmission
// After successful sale and before closing modal
alert('Sale completed successfully!');
generateInvoice(saleData); // Add this line
// Clear all form fields
document.getElementById('customerForm').reset();
document.getElementById('paymentDetails').innerHTML = '';
document.getElementById('modalTotal').textContent = '0.00';
document.getElementById('dueAmount').textContent = '0.00';
window.closeCheckoutModal();
window.clearCart();
loadProducts();
        } catch (error) {
            console.error('Error processing sale:', error);
            alert(error.message || 'Error processing sale. Please try again.');
        }
    };
    // Add this function inside the type="module" script section, before handleFormSubmission
    window.getPaymentDetails = function(method) {
        const details = {};
    
        switch(method) {
            case 'card':
                details.cardNumber = document.getElementById('cardNumber')?.value;
                details.cardName = document.getElementById('cardName')?.value;
                break;
            case 'online':
                details.transactionId = document.getElementById('transactionId')?.value;
                break;
            case 'due':
                details.dueDate = document.getElementById('dueDate')?.value;
                break;
            default:
                details.method = 'cash';
        }
    
        return details;
    };

    // Add this function to save customer information to the customers collection
    window.saveCustomerFromSale = async function(customerInfo, saleId) {
        try {
            // Skip if no valid customer information
            if (!customerInfo || (!customerInfo.name && !customerInfo.phone)) {
                console.log('No valid customer information to save');
                return;
            }
            
            console.log('Saving customer from sale:', customerInfo);
            
            // Check if customer already exists by phone or email
            let existingCustomerId = null;
            let existingCustomer = null;
            
            if (customerInfo.phone) {
                const phoneQuery = window.query(
                    window.collection(window.db, 'customers'), 
                    window.where('phone', '==', customerInfo.phone)
                );
                const phoneSnapshot = await window.getDocs(phoneQuery);
                
                if (!phoneSnapshot.empty) {
                    existingCustomerId = phoneSnapshot.docs[0].id;
                    existingCustomer = phoneSnapshot.docs[0].data();
                    console.log('Found existing customer by phone:', existingCustomer);
                }
            }
            
            if (!existingCustomerId && customerInfo.email) {
                const emailQuery = window.query(
                    window.collection(window.db, 'customers'), 
                    window.where('email', '==', customerInfo.email)
                );
                const emailSnapshot = await window.getDocs(emailQuery);
                
                if (!emailSnapshot.empty) {
                    existingCustomerId = emailSnapshot.docs[0].id;
                    existingCustomer = emailSnapshot.docs[0].data();
                    console.log('Found existing customer by email:', existingCustomer);
                }
            }
            
            if (existingCustomerId) {
                // Update existing customer with new sale
                const customerRef = window.doc(window.db, 'customers', existingCustomerId);
                
                // Update purchase count and total
                const purchaseCount = (existingCustomer.purchaseCount || 0) + 1;
                const totalPurchase = (existingCustomer.totalPurchase || 0) + parseFloat(saleData.grandTotal);
                
                // Add this sale to the customer's sales array
                const sales = existingCustomer.sales || [];
                sales.push(saleId);
                
                await window.updateDoc(customerRef, {
                    purchaseCount: purchaseCount,
                    totalPurchase: totalPurchase,
                    sales: sales,
                    lastPurchase: new Date().toISOString()
                });
                
                console.log('Updated existing customer:', existingCustomerId);
                return existingCustomerId;
            } else {
                // Create new customer
                const customerId = 'CUST' + Math.floor(100000 + Math.random() * 900000);
                
                const newCustomer = {
                    id: customerId,
                    name: customerInfo.name || 'Unknown',
                    phone: customerInfo.phone || '',
                    email: customerInfo.email || '',
                    address: customerInfo.address || '',
                    purchaseCount: 1,
                    totalPurchase: parseFloat(saleData.grandTotal),
                    sales: [saleId],
                    source: 'Electronics POS Sale',
                    createdAt: new Date().toISOString(),
                    lastPurchase: new Date().toISOString()
                };
                
                const docRef = await window.addDoc(window.collection(window.db, 'customers'), newCustomer);
                console.log('Created new customer:', customerId);
                return docRef.id;
            }
        } catch (error) {
            console.error('Error saving customer from sale:', error);
            // Don't throw the error to prevent interrupting the sale process
            return null;
        }
    };

    // ... rest of your code ...
        
    </script>
<style>
    .cart-section {
        position: fixed;
        top: -100%;
        right: 0;
        width: 350px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        transition: top 0.3s ease-in-out;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }
    
    .cart-section.active {
        top: 0;
    }
    
    .cart-toggle-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        padding: 10px 15px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1001;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .cart-toggle-btn:hover {
        background: #0056b3;
    }
    
    .cart-item-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        min-width: 18px;
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .cart-section {
            width: 100%;
        }
    }
</style><style>
    .cart-section {
        position: fixed;
        top: -100%;
        right: 0;
        width: 350px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        transition: top 0.3s ease-in-out;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }
    
    .cart-section.active {
        top: 0;
    }
    
    .cart-toggle-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        padding: 10px 15px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1001;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .cart-toggle-btn:hover {
        background: #0056b3;
    }
    
    .cart-item-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        min-width: 18px;
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .cart-section {
            width: 100%;
        }
    }
</style>
<style>
    /* Add this to your existing styles */
    .pagination-controls {
        display: flex;
    align-items: center;
    margin-left: 15px;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    }
    
    .pagination-controls button {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px 10px;
        margin: 0 5px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .pagination-controls button:hover:not(:disabled) {
        background-color: #e0e0e0;
    }
    
    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    #pageInfo {
        margin: 0 10px;
        font-size: 14px;
    }
    
    /* Make the sub div display items in a row */
    .sub {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        padding: 10px 15px;
        background-color: #f9f9f9;
        border-bottom: 1px solid #eee;
    }
    
    @media (max-width: 768px) {
        .pagination-controls {
            margin-top: 10px;
            margin-left: 0;
        }
        
        .sub {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .sub > * {
            margin-bottom: 10px;
        }
    }
</style>
<style>
    /* Add this to your existing styles */
    .page-size-selector {
        margin-left: 15px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
        font-size: 14px;
    }
    
    /* Update pagination controls style */
    .pagination-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
    }
    
    .pagination-controls button {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px 10px;
        margin: 0 5px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .pagination-controls button:hover:not(:disabled) {
        background-color: #e0e0e0;
    }
    
    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    #pageInfo {
        margin: 0 10px;
        font-size: 14px;
        min-width: 80px;
        text-align: center;
    }
</style>
</body>
</html>
