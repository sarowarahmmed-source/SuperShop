<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="pos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Replace the existing search-filter-container -->
    <!-- Add this right after <body> tag -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>IMS</h3>
            <button class="close-sidebar" onclick="toggleSidebar()">Ã—</button>
        </div>
        <ul class="sidebar-menu">
            <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="pos.html"class="active"><i class="fas fa-shopping-cart"></i> Pos</a></li>
            <li><a href="electronics-pos.html"><i class="fas fa-shopping-cart"></i> E-Pos</a></li>
            <li><a href="inventory.html"><i class="fas fa-box"></i> Inventory</a></li>
            <li><a href="vat.html"><i class="fas fa-percent"></i> Tax</a></li>
            <li><a href="sales.html"><i class="fas fa-store"></i> Sales</a></li>
            <li><a href="user-sales.html" ><i class="fas fa-exclamation-triangle"></i> User-Management</a></li>
            <li><a href="employee.html"><i class="fas fa-bars"></i> Employee</a></li>
            <li><a href="expenses.html"><i class="fas fa-money-bill-wave"></i> Expenses</a></li>
            <li><a href="customers.html"><i class="fas fa-users"></i> Customer</a></li>
            <li><a href="ecommerce.html"><i class="fab fa-google-wallet"></i> Ecomerce</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>
    
    <!-- Add hamburger button in pos-header -->
    <div class="pos-header">
        <button class="hamburger-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="search-filter-container">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Search by name, ID, code...">
            </div>
            <div class="filter-box">
                <div class="filter-group">
                    <i class="fas fa-filter"></i>
                    <select id="categoryFilter" >
                        <option value="">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Food">Food</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                    </select>
                </div>
                <div class="filter-group">
                    <i class="fas fa-box"></i>
                    <select id="stockFilter">
                        <option value="">All Stock</option>
                        <option value="inStock">In Stock</option>
                        <option value="lowStock">Low Stock (< 10)</option>
                        <option value="outOfStock">Out of Stock</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="pos-container">
        <!-- Add this right after the pos-container opening div and before products-grid -->
       
        <div class="products-grid">
            <!-- Products will be loaded here -->
        </div>
        <div class="cart-section">
            <h2>Shopping Cart</h2>
            <div class="cart-items">
                <!-- Cart items will be added here -->
            </div>
            <div class="cart-total">
                <h3>Total: $<span id="total">0.00</span></h3>
                <button class="checkout-btn">Checkout</button>
            </div>
        </div>
    </div>

    <!-- Add this modal div right after the pos-container div -->
    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <button class="product-modal-close" onclick="closeProductModal()">&times;</button>
            <div id="productDetails"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc } 
        from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
        const firebaseConfig = {
            apiKey: "AIzaSyBDz5gR_Zb-EOCga3G7pX3N2Rqwef4_hIw",
            authDomain: "supershop-bc036.firebaseapp.com",
            databaseURL: "https://supershop-bc036-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "supershop-bc036",
            storageBucket: "supershop-bc036.firebasestorage.app",
            messagingSenderId: "528401541608",
            appId: "1:528401541608:web:e1b352f95286170de09c5d",
            measurementId: "G-W4D9D0Z20S"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        // Make db accessible globally
        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.addDoc = addDoc;
    
        // Load products function
        // Update the loadProducts function in your module script
        // Update the loadProducts function
        // Add this function after Firebase initialization
       // Fix the loadCategories function
async function loadCategories() {
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.innerHTML = '<option value="">All Categories</option>';
    
    try {
        const querySnapshot = await getDocs(collection(db, 'categories'));
        querySnapshot.forEach((doc) => {
            const category = doc.data();
            categoryFilter.innerHTML += `
                <option value="${category.name}">${category.name}</option>
            `;
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}
    // Add this function to load stock settings
    async function loadStockSettings() {
        try {
            const settingsSnapshot = await getDocs(collection(db, 'settings'));
            if (!settingsSnapshot.empty) {
                const settings = settingsSnapshot.docs[0].data();
                const stockFilter = document.getElementById('stockFilter');
                const lowStockThreshold = settings.lowStockThreshold || 10;
                
                stockFilter.innerHTML = `
                    <option value="">All Stock</option>
                    <option value="inStock">In Stock</option>
                    <option value="lowStock">Low Stock (< ${lowStockThreshold})</option>
                    <option value="outOfStock">Out of Stock</option>
                `;
            }
        } catch (error) {
            console.error('Error loading stock settings:', error);
        }
    }
    // Update the loadProducts function to use the dynamic threshold
    // Update the loadProducts function to only show products from valid categories
    // Update the loadProducts function to use pagination
    window.loadProducts = async function() {
        await loadCurrencySettings();
        const productsGrid = document.querySelector('.products-grid');
        const querySnapshot = await getDocs(collection(db, 'inventory'));
        const searchQuery = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const stockFilter = document.getElementById('stockFilter').value;
        
        // Get stock threshold from settings
        let lowStockThreshold = 10;
        try {
            const settingsSnapshot = await getDocs(collection(db, 'settings'));
            if (!settingsSnapshot.empty) {
                const settings = settingsSnapshot.docs[0].data();
                lowStockThreshold = settings.lowStockThreshold || 10;
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
        
        // Get valid categories from the dropdown
        const categorySelect = document.getElementById('categoryFilter');
        const validCategories = new Set();
        
        // Add all categories from the dropdown to the valid categories set
        for (let i = 0; i < categorySelect.options.length; i++) {
            const categoryValue = categorySelect.options[i].value;
            if (categoryValue) { // Skip the "All Categories" option which has empty value
                validCategories.add(categoryValue);
            }
        }
        
        // Clear the products grid
        productsGrid.innerHTML = '';
        
        // Create an array to store filtered products
        const filteredProducts = [];
        
        querySnapshot.forEach((doc) => {
            const item = doc.data();
            
            // Check if product belongs to a valid category
            const isValidCategory = validCategories.has(item.category);
            
            // Skip products that don't belong to any valid category
            if (!isValidCategory) {
                return;
            }
            
            // Apply search filter
            const matchesSearch = 
                item.name.toLowerCase().includes(searchQuery) ||
                (item.id && item.id.toLowerCase().includes(searchQuery)) ||
                (item.specialCode && item.specialCode.toLowerCase().includes(searchQuery));
        
            // Apply category filter
            const matchesCategory = !categoryFilter || item.category === categoryFilter;
        
            // Apply stock filter
            const quantity = parseInt(item.quantity);
            let matchesStock = true;
            if (stockFilter) {
                if (stockFilter === 'inStock' && quantity <= 0) matchesStock = false;
                if (stockFilter === 'lowStock' && (quantity <= 0 || quantity > lowStockThreshold)) matchesStock = false;
                if (stockFilter === 'outOfStock' && quantity > 0) matchesStock = false;
            }
        
            // Only add to filtered products if all filters match
            if (matchesSearch && matchesCategory && matchesStock) {
                filteredProducts.push({
                    id: doc.id,
                    ...item
                });
            }
        });
        
        // Pagination variables
        const itemsPerPage = 50;
        const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
        let currentPage = parseInt(localStorage.getItem('currentPosPage') || '1');
        
        // Make sure current page is valid
        if (currentPage > totalPages) {
            currentPage = 1;
        }
        
        // Calculate start and end indices for current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredProducts.length);
        
        // Display only products for current page
        for (let i = startIndex; i < endIndex; i++) {
            const item = filteredProducts[i];
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.onclick = () => showProductDetails(item, item.id);
            productCard.innerHTML = `
                <div class="product-image">
                    ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}">` : 
                    '<div class="no-image"><i class="fas fa-image"></i></div>'}
                </div>
                <div class="product-info">
                    <h3>${item.name}</h3>
                    <p class="price">${formatCurrency(parseFloat(item.price))}</p>
                    <p class="stock">Stock: ${item.quantity}</p>
                </div>
                <button class="add-to-cart" onclick="event.stopPropagation(); addToCart('${item.id}', '${item.name}', ${item.price}, 1)">
                    Add to Cart
                </button>
            `;
            productsGrid.appendChild(productCard);
        }
        
        // Create pagination controls
        createPagination(currentPage, totalPages);
    };
    
    // Function to create pagination controls
    function createPagination(currentPage, totalPages) {
        // Add pagination container after products grid
        const productsGrid = document.querySelector('.products-grid');
        let paginationContainer = document.querySelector('.pagination-container');
        
        if (!paginationContainer) {
            paginationContainer = document.createElement('div');
            paginationContainer.className = 'pagination-container';
            productsGrid.parentNode.insertBefore(paginationContainer, productsGrid.nextSibling);
        }
        
        paginationContainer.innerHTML = '';
        
        if (totalPages <= 1) {
            return; // No pagination needed
        }
        
        // Previous button
        const prevButton = document.createElement('button');
        prevButton.className = 'pagination-btn';
        prevButton.innerHTML = 'Previous';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                localStorage.setItem('currentPosPage', currentPage - 1);
                loadProducts();
            }
        });
        paginationContainer.appendChild(prevButton);
        
        // Page numbers
        const pageNumbersContainer = document.createElement('div');
        pageNumbersContainer.className = 'page-numbers';
        
        if (totalPages <= 7) {
            // Show all pages if 7 or fewer
            for (let i = 1; i <= totalPages; i++) {
                addPageNumber(i, pageNumbersContainer, currentPage);
            }
        } else {
            // Always show first page
            addPageNumber(1, pageNumbersContainer, currentPage);
            
            if (currentPage <= 3) {
                // Near the start
                for (let i = 2; i <= 5; i++) {
                    addPageNumber(i, pageNumbersContainer, currentPage);
                }
                addEllipsis(pageNumbersContainer);
                addPageNumber(totalPages, pageNumbersContainer, currentPage);
            } else if (currentPage >= totalPages - 2) {
                // Near the end
                addEllipsis(pageNumbersContainer);
                for (let i = totalPages - 4; i <= totalPages; i++) {
                    addPageNumber(i, pageNumbersContainer, currentPage);
                }
            } else {
                // Middle - show current page with neighbors
                addEllipsis(pageNumbersContainer);
                for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                    addPageNumber(i, pageNumbersContainer, currentPage);
                }
                addEllipsis(pageNumbersContainer);
                addPageNumber(totalPages, pageNumbersContainer, currentPage);
            }
        }
        
        paginationContainer.appendChild(pageNumbersContainer);
        
        // Next button
        const nextButton = document.createElement('button');
        nextButton.className = 'pagination-btn';
        nextButton.innerHTML = 'Next';
        nextButton.disabled = currentPage === totalPages;
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                localStorage.setItem('currentPosPage', currentPage + 1);
                loadProducts();
            }
        });
        paginationContainer.appendChild(nextButton);
    }
    
    // Helper function to add a page number
    function addPageNumber(pageNum, container, currentPage) {
        const pageElement = document.createElement('div');
        pageElement.className = `page-number ${pageNum === currentPage ? 'active' : ''}`;
        pageElement.textContent = pageNum;
        pageElement.addEventListener('click', () => {
            if (pageNum !== currentPage) {
                localStorage.setItem('currentPosPage', pageNum);
                loadProducts();
            }
        });
        container.appendChild(pageElement);
    }
    
    // Helper function to add ellipsis
    function addEllipsis(container) {
        const ellipsis = document.createElement('div');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '...';
        container.appendChild(ellipsis);
    }
    // Add these lines before the initial loadProducts() call
    loadCategories();
    loadStockSettings();
    // Add this to your existing script section
    // In your module script section, update the processVat function
    window.processVat = async function(items) {
        const vatRules = await getDocs(collection(db, 'vatRules'));
        const rules = {};
        vatRules.forEach(doc => {
            const rule = doc.data();
            rules[rule.specialCode] = {
                id: doc.id,
                ...rule
            };
        });
    
        for (const item of items) {
            const product = await getDoc(doc(db, 'inventory', item.id));
            const productData = product.data();
            
            if (productData.specialCode && rules[productData.specialCode]) {
                const rule = rules[productData.specialCode];
                const vatAmount = (item.price * item.quantity) * (rule.vatPercentage / 100);
                
                await updateDoc(doc(db, 'vatRules', rule.id), {
                    totalSales: (rule.totalSales || 0) + (item.price * item.quantity),
                    totalVatCollected: (rule.totalVatCollected || 0) + vatAmount
                });
            }
        }
    }
    // Update the checkout button click handler
    document.querySelector('.checkout-btn').addEventListener('click', async function() {
        if (cart.length === 0) {
            alert('Cart is empty!');
            return;
        }
        
        try {
            await processVat(cart);
            // Add your existing checkout logic here
            cart = [];
            updateCart();
            alert('Checkout successful!');
        } catch (error) {
            console.error('Checkout error:', error);
            alert('Error processing checkout. Please try again.');
        }
    });
    // Add these event listeners after your loadProducts function
    document.getElementById('searchInput').addEventListener('input', debounce(loadProducts, 300));
    document.getElementById('categoryFilter').addEventListener('change', loadProducts);
    document.getElementById('stockFilter').addEventListener('change', loadProducts);
    
        // Add debounce function to prevent too many searches while typing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    
        // Initial load
        loadProducts();
    </script>
    <script src="pos.js"></script>
</body>
</html>
<div class="products-section">
    <!-- Your existing products container -->
    <div id="productsContainer" class="products-container"></div>
    
    <!-- Pagination will be added here -->
    <div id="paginationContainer" class="pagination-container"></div>
</div>